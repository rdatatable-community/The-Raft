<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Ivan Krylov">
<meta name="dcterms.date" content="2025-01-13">

<title>Use of non-API entry points in data.table – Blog</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-listing/list.min.js"></script>
<script src="../../site_libs/quarto-listing/quarto-listing.js"></script>
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-b0f6c8e8ab186431f151f490064c31ad.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script>

  window.document.addEventListener("DOMContentLoaded", function (_event) {
    const listingTargetEl = window.document.querySelector('#listing-listing .list');
    if (!listingTargetEl) {
      // No listing discovered, do not attach.
      return; 
    }

    const options = {
      valueNames: ['listing-date','listing-title','listing-author','listing-subtitle','listing-image','listing-description','listing-categories',{ data: ['index'] },{ data: ['categories'] },{ data: ['listing-date-sort'] },{ data: ['listing-file-modified-sort'] }],
      
      searchColumns: ["listing-date","listing-title","listing-author","listing-subtitle","listing-image","listing-description","listing-categories"],
    };

    window['quarto-listings'] = window['quarto-listings'] || {};
    window['quarto-listings']['listing-listing'] = new List('listing-listing', options);

    if (window['quarto-listing-loaded']) {
      window['quarto-listing-loaded']();
    }
  });

  window.addEventListener('hashchange',() => {
    if (window['quarto-listing-loaded']) {
      window['quarto-listing-loaded']();
    }
  })
  </script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
<link rel="alternate" type="application/rss+xml" title="Blog" href="index.xml" data-external="1"></head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/rdatatable"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://fosstodon.org/@r_data_table"> <i class="bi bi-mastodon" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://bsky.app/profile/rdatatable.bsky.social"> <i class="bi bi-cloud" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/r_data_table"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../index.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="mailto:r.data.table@gmail.com"> <i class="bi bi-envelope" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Use of non-API entry points in <code>data.table</code></h1>
                                <div class="quarto-categories">
                <div class="quarto-category">developer</div>
                <div class="quarto-category">guest post</div>
                <div class="quarto-category">performance</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Ivan Krylov </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">January 13, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        
    <h5 class="quarto-listing-category-title">Categories</h5><div class="quarto-listing-category category-default"><div class="category" data-category="">All <span class="quarto-category-count">(24)</span></div><div class="category" data-category="YW1iYXNzYWRvcnM=">ambassadors <span class="quarto-category-count">(2)</span></div><div class="category" data-category="YW5ub3VuY2VtZW50cw==">announcements <span class="quarto-category-count">(7)</span></div><div class="category" data-category="YXBwbGljYXRpb24lMjBwYWNrYWdl">application package <span class="quarto-category-count">(1)</span></div><div class="category" data-category="YmVuY2htYXJrcw==">benchmarks <span class="quarto-category-count">(1)</span></div><div class="category" data-category="YnJpZGdlJTIwcGFja2FnZQ==">bridge package <span class="quarto-category-count">(2)</span></div><div class="category" data-category="Y29tbXVuaXR5">community <span class="quarto-category-count">(4)</span></div><div class="category" data-category="Y29uZmVyZW5jZXM=">conferences <span class="quarto-category-count">(1)</span></div><div class="category" data-category="ZGV2ZWxvcGVy">developer <span class="quarto-category-count">(4)</span></div><div class="category" data-category="ZG9jdW1lbnRhdGlvbg==">documentation <span class="quarto-category-count">(2)</span></div><div class="category" data-category="ZXh0ZW5zaW9uJTIwcGFja2FnZQ==">extension package <span class="quarto-category-count">(1)</span></div><div class="category" data-category="ZnVuZGluZyUyMG9wcG9ydHVuaXR5">funding opportunity <span class="quarto-category-count">(2)</span></div><div class="category" data-category="Z292ZXJuYW5jZQ==">governance <span class="quarto-category-count">(2)</span></div><div class="category" data-category="Z3JhbnQ=">grant <span class="quarto-category-count">(9)</span></div><div class="category" data-category="Z3Vlc3QlMjBwb3N0">guest post <span class="quarto-category-count">(2)</span></div><div class="category" data-category="b3Bpbmlvbg==">opinion <span class="quarto-category-count">(1)</span></div><div class="category" data-category="cGFydG5lciUyMHBhY2thZ2U=">partner package <span class="quarto-category-count">(1)</span></div><div class="category" data-category="cGVyZm9ybWFuY2U=">performance <span class="quarto-category-count">(1)</span></div><div class="category" data-category="cmVsZWFzZXM=">releases <span class="quarto-category-count">(1)</span></div><div class="category" data-category="c2VhbCUyMG9mJTIwYXBwcm92YWw=">seal of approval <span class="quarto-category-count">(6)</span></div><div class="category" data-category="dGVzdGluZw==">testing <span class="quarto-category-count">(2)</span></div><div class="category" data-category="dGlwcw==">tips <span class="quarto-category-count">(4)</span></div><div class="category" data-category="dHJhbnNsYXRpb24=">translation <span class="quarto-category-count">(1)</span></div><div class="category" data-category="dHJhdmVs">travel <span class="quarto-category-count">(1)</span></div><div class="category" data-category="dHV0b3JpYWxz">tutorials <span class="quarto-category-count">(5)</span></div></div></div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<p>In the late 1970’s, people at Bell Laboratories designed the S programming language in order to facilitate interactive exploratory data analysis <span class="citation" data-cites="Chambers2016">(<a href="#ref-Chambers2016" role="doc-biblioref">Chambers 2016</a>)</span>. Instead of writing, compiling, scheduling, and interpreting the output of individual Fortran programs, the goal of S was to conduct all the necessary steps of the analysis on the fly. S achieved this not by replacing the extensive collection of Fortran subroutines, but by providing a special interface language <span class="citation" data-cites="Becker1985">(<a href="#ref-Becker1985" role="doc-biblioref">Becker and Chambers 1985</a>)</span> through which S could communicate with compiled code.</p>
<p>Fast forward more than four decades and an increase by more than three orders of magnitude in storage and processing capability of computers around us. The <a href="https://developer.r-project.org/blosxom.cgi/R-devel/NEWS/2024/03/08#n2024-03-09">dominant implementation of S is now R</a>. It is now feasible to implement algorithms solely in R, recouping the potential performance losses by reducing the programmer effort spent debugging and maintaining the code <span class="citation" data-cites="Nash2024">(<a href="#ref-Nash2024" role="doc-biblioref">Nash and Bhattacharjee 2024</a>)</span>. Still, the capability of R to be extended by special-purpose compiled code is as important as ever. As of 2024-11-29, 22% of CRAN packages use compiled code. Since the implementation language of R is C, not Fortran, the application programming interface (API) for R is mainly defined in terms of C.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="image.jpg" class="img-fluid figure-img"></p>
<figcaption>A visual metaphor for something that one does fully knowing what they are doing, at their own peril, until one day it fails.</figcaption>
</figure>
</div>
<p><sub>Image attribution: <a href="https://en.wikipedia.org/wiki/File:Suicide_cable.jpg">Wikipedia user ArnoldReinhold</a>.</sub></p>
<section id="whats-in-an-api" class="level1">
<h1>What’s in an API?</h1>
<p><a href="https://cran.r-project.org/doc/manuals/R-exts.html">Writing R Extensions</a> (“WRE”) is the definitive guide for R package development. Together with the <a href="https://cran.r-project.org/web/packages/policies.html">CRAN policy</a> it forms the “rules as written” that the maintainers of CRAN packages must follow. A recent version of R exports 1202 symbols, including 1049 functions (“entry points”, not counting C preprocessor macros) and 153 variables. Not all of them are intended to be used by packages. Even back in R-3.3.0, the oldest version currently supported by <code>data.table</code>, <a href="https://web.archive.org/web/20160609093632/https://cran.r-project.org/doc/manuals/R-exts.html#The-R-API">WRE chapter 6, “The R API”</a> classified R’s entry points into four categories:</p>
<blockquote class="blockquote">
<ul>
<li><strong>API</strong> Entry points which are documented in this manual and declared in an installed header file. These can be used in distributed packages and will only be changed after deprecation.</li>
<li><strong>public</strong> Entry points declared in an installed header file that are exported on all R platforms but are not documented and subject to change without notice.</li>
<li><strong>private</strong> Entry points that are used when building R and exported on all R platforms but are not declared in the installed header files. Do not use these in distributed code.</li>
<li><strong>hidden</strong> Entry points that are where possible (Windows and some modern Unix-alike compilers/loaders when using R as a shared library) not exported.</li>
</ul>
</blockquote>
<p>Although nobody objected to the use of the <em>API</em> entry points, and there was little point in trying to use the <em>hidden</em> entry points in a package that would fail to link almost everywhere, the <em>public</em> and the <em>private</em> entry points ended up being a point of contention. Those deemed too internal to use but not feasible to make <em>hidden</em> were (and still are) listed in the character vector <code>tools:::nonAPI</code>: <code>R CMD check</code> looks at the functions imported by the package and signals a <code>NOTE</code> if it finds any listed there.</p>
<p>The remaining <em>public</em> functions, neither documented as API nor explicitly forbidden by <code>R CMD check</code>, sat there, alluring the package developers with their offers. For example, the <a href="https://homepage.divms.uiowa.edu/~luke/R/serialize/serialize.html">serialization interface</a> is only <a href="https://cran.r-project.org/doc/manuals/r-devel/R-exts.html#Custom-serialization-input-and-output">documented in WRE since R-4.5</a>, but it has been powering part of the <a href="https://cran.r-project.org/package=digest">digest</a> CRAN package since 2019 (and other packages before it) without any drastic changes. Some of the inclusions in <code>tools:::nonAPI</code> could have been historical mistakes: while WRE has been saying <a href="https://web.archive.org/web/20160609093632/https://cran.r-project.org/doc/manuals/R-exts.html#Distribution-functions">back in version 3.3.0</a> that <code>wilcox_free</code> should be called after a call to the (API) functions <code>dwilcox</code>, <code>pwilcox</code> or <code>qwilcox</code>, the function was only <a href="https://github.com/r-devel/r-svn/commit/1638b0106279aa1944b17742054bc6882656596e">declared in the public headers</a> and <a href="https://github.com/r-devel/r-svn/commit/32ea1f67f842e3247f782a91684023b0b5eec6c5">removed from <code>tools:::nonAPI</code></a> in R-4.2.0. Still, between R-3.3.3 and R-4.4.2, the <code>#define USE_RINTERNALS</code> escape hatch finally closed, <code>tools:::nonAPI</code> grew from 259 to 272 entries, and the package maintainers had to adapt or face archival of their packages.</p>
<p>A <a href="https://stat.ethz.ch/pipermail/r-devel/2024-April/083339.html">recent question on R-devel</a> (whether the <a href="https://svn.r-project.org/R/branches/ALTREP/ALTREP.html">ALTREP</a> interface should be considered “API” for the purpose of CRAN package development) sparked a series of events and an extensive discussion containing the highest count of occurrences of the word “API” per month ever seen on R-devel (234), topping <a href="https://stat.ethz.ch/pipermail/r-devel/2002-October/thread.html">October 2002</a> (package versioning and API breakage, 150), <a href="https://stat.ethz.ch/pipermail/r-devel/2005-October/thread.html">October 2005</a> (API for graphical interfaces and console output, 124), and <a href="https://stat.ethz.ch/pipermail/r-devel/2019-May/thread.html">May 2019</a> (discussions of the ALTREP interface and multi-threading, 121). As a result, Luke Tierney <a href="https://stat.ethz.ch/pipermail/r-devel/2024-June/083449.html">started work</a> on programmatically describing the functions and other symbols exported by R (including variables and preprocessor and enumeration constants), giving a stronger definition to the interface. His changes add the currently unexported function <code>tools:::funAPI()</code> that lists entry points and two more of their categories:</p>
<blockquote class="blockquote">
<ul>
<li><strong>experimental</strong> Entry points declared in an installed header file that are part of an experimental API, such as <code>R_ext/Altrep.h</code>. These are subject to change, so package authors wishing to use these should be prepared to adapt.</li>
<li><strong>embedding</strong> Entry points intended primarily for embedding and creating new front-ends. It is not clear that this needs to be a separate category but it may be useful to keep it separate for now.</li>
</ul>
</blockquote>
<p>Additionally, WRE now spells out that entry points not explicitly documented or at least listed in the output of <code>tools:::funAPI</code> (or something that will replace it) are now off-limits, even if not currently present in <code>tools:::nonAPI</code> (emphasis added):</p>
<blockquote class="blockquote">
<ul>
<li><strong>public</strong> Entry points declared in an installed header file that are exported on all R platforms but are not documented and subject to change without notice. <em>Do not use these in distributed code. Their declarations will eventually be moved out of installed header files.</em></li>
</ul>
</blockquote>
<p>Correspondingly, the number of <code>tools:::nonAPI</code> entry points in the current development version of R rose to 322, prompting the blog post you are currently reading.</p>
<!-- MAYBE: mention Rf_ remapping and typical APIs look like at some
point -->
<!-- MAYBE: somehow obtain the list of imports (mirror Windows builds
from CRAN? Download the one compiled by Luke Tierney?) and try to
extract neither-official-API nor-official-nonAPI counts -->
<!-- MAYBE: see which listed non-API functions are the most "popular" in
packages still on CRAN -->
</section>
<section id="non-api-entry-points-marked-by-r-cmd-check" class="level1">
<h1>Non-API entry points marked by <code>R CMD check</code></h1>
<p>The first version of the <code>data.table</code> package in the CRAN archive dates back to April 2006 (which corresponds to R version 2.3.0). It has been evolving together with R and its API and thus has accumulated a number of uses of R internals that are <a href="https://github.com/Rdatatable/data.table/issues/6180">now flagged by <code>R CMD check</code> as non-API</a>:</p>
<blockquote class="blockquote">
<pre><code>Package: data.table 1.16.2
Flavor: r-devel-linux-x86_64-debian-clang
Check: compiled code, Result: NOTE
  File ‘data.table/libs/data_table.so’:
    Found non-API calls to R: ‘LEVELS’, ‘SETLENGTH’, ‘SET_GROWABLE_BIT’,
      ‘SET_TRUELENGTH’, ‘STRING_PTR’, ‘TRUELENGTH’
  
  Compiled code should not call non-API entry points in R.
  
  See ‘Writing portable packages’ in the ‘Writing R Extensions’ manual,
  and section ‘Moving into C API compliance’ for issues with the use of
  non-API entry points.</code></pre>
</blockquote>
<p>– <code>R CMD check --as-cran</code> on a released version of <code>data.table</code></p>
<section id="operating-on-the-s4-bit-is_s4_object-set_s4_object-unset_s4_object" class="level2">
<h2 class="anchored" data-anchor-id="operating-on-the-s4-bit-is_s4_object-set_s4_object-unset_s4_object">Operating on the S4 bit: <code>IS_S4_OBJECT</code>, <code>SET_S4_OBJECT</code>, <code>UNSET_S4_OBJECT</code></h2>
<p>In R’s “S4” OOP system, objects can have a primitive base type (e.g.&nbsp;<code>setClass("PrimitiveBaseType", contains = "numeric")</code> or no base type at all (e.g.&nbsp;<code>setClass("NoBaseType")</code>). In the former case, their <code>SEXPTYPE</code> code is that of their base class (e.g.&nbsp;<code>REALSXP</code>). In the latter case, their type code is <code>OBJSXP</code> (previously <code>S4SXP</code>, which is now an alias for <code>OBJSXP</code>). To make both cases work consistently, R uses a <a href="https://cran.r-project.org/doc/manuals/R-ints.html#Representation-of-S4-objects">special “S4” bit</a> in the header of the object.</p>
<p>The <code>data.table</code> class is <a href="https://search.r-project.org/R/refmans/methods/html/setOldClass.html">registered</a> with the S4 OOP system, making it possible to create S4 classes containing <code>data.table</code>s as members (<code>setClass(slots = c(mytable = 'data.table'))</code>) or even inheriting from <code>data.table</code> (and, in turn, from <code>data.frame</code>: <code>setClass(contains = 'data.table')</code>). Additionally, <code>data.table</code>s may contain columns that are themselves S4 objects, and both of these cases require care from the C code.</p>
<p>The undocumented functions <code>IS_S4_OBJECT</code>, <code>SET_S4_OBJECT</code>, <code>UNSET_S4_OBJECT</code> exist as bare interfaces to <a href="https://github.com/r-devel/r-svn/blob/c20ebd2d417d9ebb915e32bfb0bfdad768f9a80a/src/main/memory.c#L4033-L4035">the internal macros</a> of the same names and directly access the flag inside their argument. Writing R Extensions <a href="https://cran.r-project.org/doc/manuals/r-devel/R-exts.html#Some-API-replacements-for-non_002dAPI-entry-points">documents</a> <code>Rf_isS4</code> and <code>Rf_asS4</code> as their replacements.</p>
<p>The <a href="https://github.com/r-devel/r-svn/blob/c20ebd2d417d9ebb915e32bfb0bfdad768f9a80a/src/main/objects.c#L1838-L1841"><code>Rf_isS4</code></a> function is a wrapper for <code>IS_S4_OBJECT</code> that follows the usual naming convention for remapped functions, has been part of the API for a long time, and could implement additional checks if they are needed by R. The <a href="https://github.com/r-devel/r-svn/blob/c20ebd2d417d9ebb915e32bfb0bfdad768f9a80a/src/main/objects.c#L1843"><code>Rf_asS4</code></a> function (experimental API) is more involved, trying to “deconstruct” S4 objects into S3 objects if possible and requested to. If the <a href="#NAMED">reference count</a> of its argument is <em>above</em> 1, it will operate upon and return its shallow duplicate.</p>
<p><code>data.table</code> used to directly operate on the S4 bit in two places, the <a href="https://github.com/Rdatatable/data.table/blob/a2e20d6cab0bc3cd00f8e47d10603e8c04c89759/src/assign.c#L156"><code>shallow</code> function in <code>src/assign.c</code></a> and the <a href="https://github.com/Rdatatable/data.table/blob/a2213177283f0f15823e1ff823c1fdf63746da3d/src/dogroups.c#L485"><code>keepattr</code> function in <code>src/dogroups.c</code></a>. In both cases, this was required after directly modifying attribute list using the undocumented function <a href="#ATTRIB-all"><code>SET_ATTRIB</code></a>. For <code>shallow</code>, the solution was to replace the manual operation of attributes with <a href="https://github.com/Rdatatable/data.table/commit/f952062030e6657bef83de2748c65120990031c1"><code>SHALLOW_DUPLICATE_ATTRIB</code></a> (API, available since 3.3.0), which itself takes care of invariants like the object bit and the S4 bit.</p>
<p>The <code>keepattr</code> function is only used in <a href="https://github.com/Rdatatable/data.table/blob/a2213177283f0f15823e1ff823c1fdf63746da3d/src/dogroups.c#L522"><code>growVector</code></a> to transplant all attributes from a vector to its enlarged copy without duplicating them, for which <a href="#ATTRIB-all">no API exists</a>. The solution is to <a href="https://github.com/Rdatatable/data.table/pull/6183">use <code>Rf_asS4</code> to control the S4 object bit</a>, knowing that the new vector is freshly allocated and thus cannot be shared yet.</p>
<p><strong>Status</strong> in <code>data.table</code>: fixed in <a href="https://github.com/Rdatatable/data.table/pull/6183">#6183</a> and <a href="https://github.com/Rdatatable/data.table/pull/6264">#6264</a>.</p>
</section>
<section id="converting-between-calls-and-pairlists-set_typeof" class="level2">
<h2 class="anchored" data-anchor-id="converting-between-calls-and-pairlists-set_typeof">Converting between calls and pairlists: <code>SET_TYPEOF</code></h2>
<p>In R, <a href="https://search.r-project.org/R/refmans/base/html/call.html">function calls</a> are internally represented as Lisp-style pairlists where the first pair is of special type <code>LANGSXP</code> instead of <code>LISTSXP</code>. For example, the following diagram illustrates the data structure of the call <code>print(x = 42L)</code>:</p>
<p><img src="langsxp.svg" class="img-fluid" style="width:40em"></p>
<p>Here, every list item is a separate R object, a “cons cell”; each cell contains the value in its <code>CAR</code> field and a reference to the rest of the list in its <code>CDR</code> field. Argument names, if provided, are stored in the third field, <code>TAG</code>. The list is terminated by <code>R_NilValue</code>, which is of type <code>NILSXP</code>. These structures must be constructed every time C code wants to evaluate a function call (<a href="https://github.com/Rdatatable/data.table/blob/03c647f9a44710aad834c0718e0b34e8c5341bf1/src/rbindlist.c#L237">e.g.</a>).</p>
<p>Previously, R API contained a function to allocate <code>LISTSXP</code> pairlists of arbitrary length, <code>allocList()</code>, but not function calls, so it became a somewhat common idiom to first allocate the list and then use <code>SET_TYPEOF</code> to change the type of the head pair to <code>LANGSXP</code>. This did not previously lead to problems, since the two types have the same internal memory layout.</p>
<p>The danger of <code>SET_TYPEOF</code> lies in the possibility to set the type of an R value to one with an incompatible memory layout. (For example, vector types <code>REALSXP</code> and <code>INTSXP</code> are built very differently from cons cells <code>LISTSXP</code> and <code>LANGSXP</code>.) Starting with R-4.4.1, <a href="https://cran.r-project.org/doc/manuals/r-devel/R-exts.html#Creating-call-expressions">R contains the <code>allocLang</code> function in addition to the <code>allocList</code> function</a> that directly allocates a function call object with a head pair of type <code>LANGSXP</code>. In order to stay compatible with previous R versions, packages may <a href="https://github.com/Rdatatable/data.table/pull/6313">allocate the <code>LISTSXP</code> tail first and then use <code>lcons()</code> to construct the <code>LANGSXP</code> head pair of the call</a>.</p>
<p>Problem (the only instance in <code>data.table</code>):</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>   SEXP s <span class="op">=</span> PROTECT<span class="op">(</span>allocList<span class="op">(</span><span class="dv">2</span><span class="op">));</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>   SET_TYPEOF<span class="op">(</span>s<span class="op">,</span> LANGSXP<span class="op">);</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co">// ^^^^^^^^^^ unsafe operation, could be used to corrupt objects</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>   SETCAR<span class="op">(</span>s<span class="op">,</span> install<span class="op">(</span><span class="st">"format.POSIXct"</span><span class="op">));</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>   SETCAR<span class="op">(</span>CDR<span class="op">(</span>s<span class="op">),</span> column<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Solutions:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">// for fixed-size calls with contents known ahead of time</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>SEXP s <span class="op">=</span> lang2<span class="op">(</span>install<span class="op">(</span><span class="st">"format.POSIXct"</span><span class="op">),</span> column<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>or:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">// partially pre-populate</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>SEXP s <span class="op">=</span> lang2<span class="op">(</span>install<span class="op">(</span><span class="st">"format.POSIXct"</span><span class="op">),</span> R_NilValue<span class="op">);</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co">// later, when 'column' is known:</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>SETCAR<span class="op">(</span>CDR<span class="op">(</span>s<span class="op">),</span> column<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>or:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">// allocate a call with 'n' elements</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>SEXP call <span class="op">=</span> lcons<span class="op">(</span>R_NilValue<span class="op">,</span> allocList<span class="op">(</span>n <span class="op">-</span> <span class="dv">1</span><span class="op">));</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>or:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">// in R &gt;= 4.4.1 only:</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>SEXP call <span class="op">=</span> allocLang<span class="op">(</span>n<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Unfortunately, the <code>LCONS</code> macro didn’t work with <code>#define R_NO_REMAP</code> prior to R-4.4, because it expanded to <code>lcons()</code> instead of <code>Rf_lcons()</code>.</p>
<p><strong>Status</strong> in <code>data.table</code>: fixed in <a href="https://github.com/Rdatatable/data.table/pull/6313">#6313</a>.</p>
</section>
<section id="strings-as-c-arrays-of-charsxp-values-string_ptr" class="level2">
<h2 class="anchored" data-anchor-id="strings-as-c-arrays-of-charsxp-values-string_ptr">Strings as C arrays of <code>CHARSXP</code> values: <code>STRING_PTR</code></h2>
<p>From the point of view of R code, strings are very simple things, much like numbers: they live in atomic vectors and can be directly compared with other objects. It is only natural to desire to work with them as easily from C code as it’s possible with other atomic types, where functions <code>REAL()</code>, <code>INTEGER()</code>, or <code>COMPLEX()</code> can be used to access the buffer containing the numbers.</p>
<p>The underlying reality of strings is more complicated: since they internally manage memory buffers containing text in a given encoding, they must be subject to garbage collection. Like other managed objects in R, they are represented as <code>SEXP</code> values of special type <code>CHARSXP</code>. R’s garbage collector is <a href="https://cran.r-project.org/doc/manuals/R-ints.html#The-write-barrier">generational and requires the use of write barrier</a> (<a href="https://homepage.stat.uiowa.edu/~luke/R/gengcnotes.html">1</a>, <a href="https://homepage.stat.uiowa.edu/~luke/R/barrier.html">2</a>) any time a <code>SEXP</code> value (such as an <code>STRSXP</code> vector) references another <code>SEXP</code> value (such as a <code>CHARSXP</code> string). In a generational garbage collector, “younger” generations are marked and sweeped more frequently than “older” ones, because in a typical R session, most objects are temporary <span class="citation" data-cites="Jones2012">(<a href="#ref-Jones2012" role="doc-biblioref">Jones, Hosking, and Moss 2012, chap. 9</a>)</span>. If package C code manually writes a reference to a “young” <code>CHARSXP</code> object into an “old” <code>STRSXP</code> vector without taking generations into account, a following collection of the “young” pool of objects will miss the <code>CHARSXP</code> being referenced by the “old” <code>STRSXP</code> and remove the <code>CHARSXP</code> as “garbage”. This makes the <code>SEXP *</code> pointers returned by <code>STRING_PTR</code> unsafe and requires the use of <code>STRING_PTR_RO</code> function, which returns a read-only <code>const SEXP *</code>.</p>
<p>Thankfully, <code>data.table</code> has already been using read-only <code>const SEXP *</code> pointers when working with <code>STRSXP</code> vectors, so the required changes to the code were <a href="https://github.com/Rdatatable/data.table/pull/6312">not too substantial</a>, limited to the name of the function:</p>
<p>Example of the problem:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="dt">const</span> SEXP <span class="op">*</span>sourceD <span class="op">=</span> STRING_PTR<span class="op">(</span>source<span class="op">);</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co">//                    ^^^^^^^^^^</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co">// returns a writeable SEXP * pointer, therefore unsafe</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Solution:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#if R_VERSION &lt; R_Version(3, 5, 0)</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co">// STRING_PTR_RO only appeared in R-3.5</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#define STRING_PTR_RO</span><span class="op">(</span><span class="pp">x</span><span class="op">)</span><span class="pp"> </span><span class="op">(</span><span class="pp">STRING_PTR</span><span class="op">(</span><span class="pp">x</span><span class="op">))</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="co">// later:</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="dt">const</span> SEXP <span class="op">*</span>sourceD <span class="op">=</span> STRING_PTR_RO<span class="op">(</span>source<span class="op">);</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co">//                    ^^^^^^^^^^^^^</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="co">// returns a const SEXP * pointer, which prevents accidental writes</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Status</strong> in <code>data.table</code>: fixed in <a href="https://github.com/Rdatatable/data.table/pull/6312">#6312</a>. See also: <a href="https://bugs.r-project.org/show_bug.cgi?id=18775">PR18775</a>.</p>
</section>
<section id="NAMED" class="level2">
<h2 class="anchored" data-anchor-id="NAMED">Reading the reference counts: <code>NAMED</code></h2>
<p>In plain R, all value types – numbers, strings, lists – have pass-by-value semantics. Without dark and disturbing things in play, such as non-standard evaluation or active bindings, R code can give a plain value (<code>x &lt;- 1:10</code>) to a function (<code>f(x)</code>) or store it in a variable (<code>y &lt;- x</code>), have the function modify its argument (<code>f &lt;- \(x) { x[1] &lt;- 0 }</code>) or change the duplicate variable (<code>y[2] &lt;- 3</code>), and still have the original value intact (<code>stopifnot(identical(x, 1:10))</code>). Only the inherently mutable types, such as environments, external pointers and weak references, will stay shared between all assignments and function arguments; the value types behave as if R copies them every time.</p>
<p>And yet actually making these copies is wasteful when the code only reads the variable and does not alter it. (In fact, one of the original motivations of <code>data.table</code> was to reduce certain wasteful copying of data that happens during normal R computations.) Until version 4.0.0, <code>NAMED</code> was R’s mechanism to save memory and CPU time instead of creating and storing these copies. A temporary object such as the value of <code>1:10</code> was not bound to a symbol and thus could be modified right away. Assigning it to a variable, as in <code>x &lt;- 1:10</code>, gave it a <code>NAMED(x)</code> count of 1, for which R had an internal optimisation in replacement function calls like <code>foo(x) &lt;- 3</code>. Assigning the same value to yet another symbol (by copying <code>y &lt;- x</code> or calling a function <code>foo(x)</code>) increased the <code>NAMED()</code> count to 2 or more, for which there was no optimisation: in order to modify one of the symbols, R was required to duplicate <code>x</code> first. <code>NAMED()</code> was not necessarily decreased after the bindings disappeared, and decreasing it after having reached <code>NAMEDMAX</code> was impossible. During the lifetime of R-3.x, <code>NAMEDMAX</code> was increased from 2 to 3 and later to 7.</p>
<p>Between R-3.1.0 and R-4.0.0, R <a href="https://developer.r-project.org/Refcnt.html">migrated from <code>NAMED</code> to reference counting</a>. Reference counts are easier to properly decrement than <code>NAMED</code>, thus preventing unneeded copies of objects that became unreferenced. R-3.5.0 <a href="https://developer.r-project.org/blosxom.cgi/R-devel/NEWS/2017/09/02#n2017-09-03">documented the symbols</a> <code>MAYBE_REFERENCED(.)</code> / <code>NO_REFERENCES(.)</code> for use instead of checking <code>NAMED(.) == 0</code>, <code>MAYBE_SHARED(.)</code> / <code>NOT_SHARED(.)</code> instead of checking <code>NAMED(.) &gt; 1</code>, and <code>MARK_NOT_MUTABLE(.)</code> instead of setting <code>NAMED(.)</code> to <code>NAMEDMAX</code>, which later became part of the API instead of the <code>NAMED(.)</code> and <code>REFCNT(.)</code> functions. The hard rules are that a value is safe to modify in place if it has <code>NO_REFERENCES()</code> (reference count of 0), definitely unsafe to modify in place (requiring a call to <code>duplicate</code> or <code>shallow_duplicate</code>) if it is <code>MAYBE_SHARED()</code> (reference count above 1), and almost certainly unsafe to modify in place if it is <code>MAYBE_REFERENCED()</code> (reference count of 1).</p>
<p><code>data.table</code>’s only uses of <code>NAMED()</code> were in the <a href="https://github.com/Rdatatable/data.table/pull/6420/files#diff-22b103646a1efab9bbfc374791ccfc3fd1422eefc48918a3e126fc2f30d1f572L552">verbose output during assignment</a>:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>verbose<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  Rprintf<span class="op">(</span>_<span class="op">(</span><span class="st">"RHS for item </span><span class="sc">%d</span><span class="st"> has been duplicated because NAMED==</span><span class="sc">%d</span><span class="st"> MAYBE_SHARED==</span><span class="sc">%d</span><span class="st">, but then is being plonked. length(values)==</span><span class="sc">%d</span><span class="st">; length(cols)==</span><span class="sc">%d</span><span class="st">)</span><span class="sc">\n</span><span class="st">"</span><span class="op">),</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>          i<span class="op">+</span><span class="dv">1</span><span class="op">,</span> NAMED<span class="op">(</span>thisvalue<span class="op">),</span> MAYBE_SHARED<span class="op">(</span>thisvalue<span class="op">),</span> length<span class="op">(</span>values<span class="op">),</span> length<span class="op">(</span>cols<span class="op">));</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>            <span class="co">// ^^^^^ non-API function</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Since the correctness of the modification operation hinges on the reference count being 0 (and it may be important whether it’s exactly 1 or above 1), the same amount of <em>useful</em> information can be conveyed by printing <code>MAYBE_REFERENCED()</code> and <code>MAYBE_SHARED()</code> instead of <code>NAMED()</code>:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>verbose<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  Rprintf<span class="op">(</span>_<span class="op">(</span><span class="st">"RHS for item </span><span class="sc">%d</span><span class="st"> has been duplicated because MAYBE_REFERENCED==</span><span class="sc">%d</span><span class="st"> MAYBE_SHARED==</span><span class="sc">%d</span><span class="st">, but then is being plonked. length(values)==</span><span class="sc">%d</span><span class="st">; length(cols)==</span><span class="sc">%d</span><span class="st">)</span><span class="sc">\n</span><span class="st">"</span><span class="op">),</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>          i<span class="op">+</span><span class="dv">1</span><span class="op">,</span> MAYBE_REFERENCED<span class="op">(</span>thisvalue<span class="op">),</span> MAYBE_SHARED<span class="op">(</span>thisvalue<span class="op">),</span> length<span class="op">(</span>values<span class="op">),</span> length<span class="op">(</span>cols<span class="op">));</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>            <span class="co">// ^^^^^^^^^^^^^^^^ API function</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Status</strong> in <code>data.table</code>: fixed in <a href="https://github.com/Rdatatable/data.table/pull/6420/files#diff-22b103646a1efab9bbfc374791ccfc3fd1422eefc48918a3e126fc2f30d1f572L552">#6420</a>.</p>
</section>
<section id="encoding-bits-levels" class="level2">
<h2 class="anchored" data-anchor-id="encoding-bits-levels">Encoding bits: <code>LEVELS</code></h2>
<p><code>LEVELS</code> is the name of the internal R <a href="https://github.com/r-devel/r-svn/blob/c9437a83b9677074fe01310caac6a2a66cc7f680/src/include/Defn.h#L228">macro</a> and an exported non-API <a href="https://github.com/r-devel/r-svn/blob/c9437a83b9677074fe01310caac6a2a66cc7f680/src/main/memory.c#L3902">function</a> accessing a <a href="https://github.com/r-devel/r-svn/blob/c9437a83b9677074fe01310caac6a2a66cc7f680/src/include/Defn.h#L132">16-bit field called <code>gp</code></a> (<a href="https://cran.r-project.org/doc/manuals/R-ints.html#Rest-of-header">general-purpose</a>) that is present in the header of every <code>SEXP</code> value. Not every access to this field is done using the <code>LEVELS()</code> macro; there are bits of R code that access <code>(sexp)-&gt;sxpinfo.gp</code> directly. R uses this field for many purposes:</p>
<ul>
<li>matching given arguments against the formals of a function (<a href="https://github.com/r-devel/r-svn/blob/c9437a83b9677074fe01310caac6a2a66cc7f680/src/main/match.c#L175">1</a>, <a href="https://github.com/r-devel/r-svn/blob/c9437a83b9677074fe01310caac6a2a66cc7f680/src/main/match.c#L233-L236">2</a>, <a href="https://github.com/r-devel/r-svn/blob/c9437a83b9677074fe01310caac6a2a66cc7f680/src/main/unique.c#L53">3</a>)</li>
<li>remembering the previous <a href="https://github.com/r-devel/r-svn/blob/c9437a83b9677074fe01310caac6a2a66cc7f680/src/main/memory.c#L151-L155">type</a> of a garbage-collected value</li>
<li><a href="https://github.com/r-devel/r-svn/blob/c9437a83b9677074fe01310caac6a2a66cc7f680/src/main/memory.c#L1364-L1374">finalizing</a> the reference-semantics objects before garbage-collecting them</li>
<li><a href="https://github.com/r-devel/r-svn/blob/c9437a83b9677074fe01310caac6a2a66cc7f680/src/main/errors.c#L1660-L1665">marking</a> condition handlers as “calling” (executing on top of where the condition was signalled in the call stack), as opposed to “non-calling” (executing at the site of the <code>tryCatch</code> call)</li>
<li><a href="https://github.com/r-devel/r-svn/blob/c9437a83b9677074fe01310caac6a2a66cc7f680/src/include/Defn.h#L280-L324">marking</a> objects in complex assignment calls</li>
<li>storing the <a href="https://github.com/r-devel/r-svn/blob/c9437a83b9677074fe01310caac6a2a66cc7f680/src/include/Defn.h#L359-L362">S4 object bit</a></li>
<li><a href="https://github.com/r-devel/r-svn/blob/c9437a83b9677074fe01310caac6a2a66cc7f680/src/include/Defn.h#L364-L371">marking</a> functions as (un)suitable for bytecode compilation</li>
<li><a href="https://github.com/r-devel/r-svn/blob/c9437a83b9677074fe01310caac6a2a66cc7f680/src/include/Defn.h#L373-L377">marking</a> vectors as growable</li>
<li><a href="https://github.com/r-devel/r-svn/blob/c9437a83b9677074fe01310caac6a2a66cc7f680/src/include/Defn.h#L449-L456">marking</a> provided (“actual”) function arguments as <a href="https://github.com/r-devel/r-svn/blob/c9437a83b9677074fe01310caac6a2a66cc7f680/src/main/eval.c#L2260-L2281">missing</a></li>
<li><a href="https://github.com/r-devel/r-svn/blob/c9437a83b9677074fe01310caac6a2a66cc7f680/src/include/Defn.h#L519-L523">marking</a> the <code>..1</code>, <code>..2</code>, etc symbols as corresponding to the <a href="https://search.r-project.org/R/refmans/base/html/dots.html">given element of the <code>...</code> argument</a></li>
<li><a href="https://github.com/r-devel/r-svn/blob/c9437a83b9677074fe01310caac6a2a66cc7f680/src/include/Defn.h#L529-L530">marking</a> environments as <a href="https://github.com/r-devel/r-svn/blob/c9437a83b9677074fe01310caac6a2a66cc7f680/src/main/envir.c#L106-L108">locked</a>, or for <a href="https://github.com/r-devel/r-svn/blob/c9437a83b9677074fe01310caac6a2a66cc7f680/src/main/envir.c#L613-L655">caching</a> the global variable lookup, or for looking up values in the base environment or the special functions (<a href="https://github.com/r-devel/r-svn/blob/c9437a83b9677074fe01310caac6a2a66cc7f680/src/include/Defn.h#L1225-L1228">1</a>, <a href="https://github.com/r-devel/r-svn/blob/c9437a83b9677074fe01310caac6a2a66cc7f680/src/main/envir.c#L754-L768">2</a>, <a href="https://github.com/r-devel/r-svn/blob/2753df314f7d8e154bc42b5abd99daaf6472dbe1/src/include/Defn.h#L1230-L1236">3</a>, <a href="https://github.com/r-devel/r-svn/blob/2753df314f7d8e154bc42b5abd99daaf6472dbe1/src/main/names.c#L1019-L1046">4</a>)</li>
<li><a href="https://github.com/r-devel/r-svn/blob/c9437a83b9677074fe01310caac6a2a66cc7f680/src/include/Defn.h#L1182-L1186">marking</a> symbols naming environment contents for <a href="https://github.com/r-devel/r-svn/blob/c9437a83b9677074fe01310caac6a2a66cc7f680/src/main/envir.c#L517-L520">hash lookup</a></li>
<li><a href="https://github.com/r-devel/r-svn/blob/c9437a83b9677074fe01310caac6a2a66cc7f680/src/include/Defn.h#L1205-L1210">marking</a> bindings inside environments as <a href="https://github.com/r-devel/r-svn/blob/c9437a83b9677074fe01310caac6a2a66cc7f680/src/main/envir.c#L3466-L3483">active</a></li>
<li><a href="https://github.com/r-devel/r-svn/blob/c9437a83b9677074fe01310caac6a2a66cc7f680/src/include/Defn.h#L1165-L1166">marking</a> promise objects as already evaluated</li>
<li><a href="https://github.com/r-devel/r-svn/blob/c9437a83b9677074fe01310caac6a2a66cc7f680/src/include/Defn.h#L843-L853">marking</a> <code>CHARSXP</code> values as present in the global cache or being in a certain encoding</li>
</ul>
<p>Although the value of <code>gp</code> is directly stored in R’s serialized data stream, neither of these are part of the API. Out of all possible uses for this flag, <code>data.table</code> is only interested in string encodings. From the viewpoints of <a href="https://search.r-project.org/R/refmans/base/html/Encoding.html">plain R</a> and the <a href="https://cran.r-project.org/doc/manuals/R-exts.html#Character-encoding-issues">C API</a>, an individual string (<code>CHARSXP</code> value) can be marked with the following encodings:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 33%">
<col style="width: 33%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">R-level encoding name</th>
<th style="text-align: center;">C-level encoding constant</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><code>"latin1"</code></td>
<td style="text-align: center;"><code>CE_LATIN1</code></td>
<td>ISO/IEC 8859-1 or CP1252</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>"UTF-8"</code></td>
<td style="text-align: center;"><code>CE_UTF8</code></td>
<td>ISO/IEC 10646</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>"unknown"</code></td>
<td style="text-align: center;"><code>CE_NATIVE</code></td>
<td>Encoding of the current locale</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>"bytes"</code></td>
<td style="text-align: center;"><code>CE_BYTES</code></td>
<td>Not necessarily text; <code>translateChar</code> will fail</td>
</tr>
</tbody>
</table>
<p>Internally, R also <a href="https://github.com/r-devel/r-svn/blob/2753df314f7d8e154bc42b5abd99daaf6472dbe1/src/main/envir.c#L4312-L4375">marks strings as encoded in ASCII</a>: since all three encodings are ASCII-compatible, an ASCII string will never need to be translated into a different encoding. Note that there is a subtle difference between a string <em>marked</em> in a certain encoding and actually <em>being</em> in a certain encoding: in an R session running with a UTF-8 locale (which includes most modern Unix-alikes and Windows ≥ 10, November 2019 update) a string marked as <code>CE_NATIVE</code> will also be in UTF-8. (Similarly, with an increasingly rare Latin-1 locale, a <code>CE_NATIVE</code> string will be in Latin-1.)</p>
<p>The <code>data.table</code> code is interested in knowing whether a string is <a href="https://github.com/Rdatatable/data.table/blob/40ad2e6978202ecc626db9eaae3a18ed5e4df769/src/data.table.h#L36-L38">marked as UTF-8, Latin-1, or ASCII</a>. This is used to <a href="https://github.com/Rdatatable/data.table/blob/40ad2e6978202ecc626db9eaae3a18ed5e4df769/src/data.table.h#L63-L73">convert strings to UTF-8 when needed</a> (also: <a href="https://github.com/Rdatatable/data.table/blob/40ad2e6978202ecc626db9eaae3a18ed5e4df769/src/fwriteR.c#L8-L12">output to native encoding or UTF-8 in <code>fwrite</code></a>, <a href="https://github.com/Rdatatable/data.table/blob/40ad2e6978202ecc626db9eaae3a18ed5e4df769/src/forder.c#L312-L331">automatic conversion in <code>forder</code></a>). The <code>getCharCE</code> API function appeared in R-2.7.0 together with the encoding support, so switching the <code>IS_UTF8</code> and <code>IS_LATIN</code> macros from <code>LEVELS</code> to API calls <a href="https://github.com/Rdatatable/data.table/pull/6420/commits/46dbfa93e72776c59dacb286de9831fa28c481b5#diff-3b83136e49e2df4f5df80b312d7d4199fed9e0d283401dbf7bd9159a5096bcaaL36">was relatively straightforward</a>.</p>
<p>R-4.5.0 is expected to introduce the <code>charIsASCII</code> “experimental” API function that returns the value of the ASCII marker for a <code>CHARSXP</code> value, which <a href="https://github.com/Rdatatable/data.table/pull/6422/commits/72cbd170fd16844dd8094b8d049d2e56d0926d22">will replace the use of <code>LEVELS</code> in the <code>IS_ASCII</code> macro</a>. Curiously, while it looks like the code could benefit from switching from the <code>getCharCE()</code> tests (which only look at the value of the flags and so may needlessly translate strings from <code>CE_NATIVE</code>) to the new experimental <code>charIs(UTF8|Latin1)</code> functions that will also return <code>TRUE</code> for a matching native encoding, actually making the change breaks a number of unit tests.</p>
<p><strong>Status</strong> in <code>data.table</code>: partially fixed in <a href="https://github.com/Rdatatable/data.table/pull/6420/commits/46dbfa93e72776c59dacb286de9831fa28c481b5#diff-3b83136e49e2df4f5df80b312d7d4199fed9e0d283401dbf7bd9159a5096bcaaL36">#6420</a>, waiting for R-4.5.0 to be released with the new API in <a href="https://github.com/Rdatatable/data.table/pull/6422/commits/72cbd170fd16844dd8094b8d049d2e56d0926d22">#6422</a>.</p>
</section>
<section id="setlength-set_growable_bit-set_truelength" class="level2">
<h2 class="anchored" data-anchor-id="setlength-set_growable_bit-set_truelength"><code>SETLENGTH</code>, <code>SET_GROWABLE_BIT</code>, <code>(SET_)TRUELENGTH</code></h2>
<section id="growable-vectors" class="level3">
<h3 class="anchored" data-anchor-id="growable-vectors">Growable vectors</h3>
<p>Since <code>data.frame</code>s and <code>data.table</code>s are lists, and lists in R are value types with <a href="#NAMED">pass-by-value semantics</a>, adding or removing a column to one normally involves allocating a new list referencing the rest of the columns (performing a “shallow duplicate”). By contrast, the <a href="https://github.com/Rdatatable/data.table/commit/e09d91beccc862eebcd9497c27b422058320396b#diff-22b103646a1efab9bbfc374791ccfc3fd1422eefc48918a3e126fc2f30d1f572R262-R276">over-allocated lists</a> can be resized in place by gradually increasing their <code>LENGTH</code> (remembering their original length in the <code>TRUELENGTH</code> field), obviating the need for shallow duplicates at the cost of making <code>data.table</code>s shared, by-reference values. The change has been introduced in <a href="https://github.com/Rdatatable/data.table/blob/6a15f8617de121a406cee97b22e83e0c2c4bb034/NEWS.0.md#new-features-13">v1.7.3, November 2011</a>, together with the <code>:=</code> operator for changing the columns by reference (which has since become <a href="https://raw.githubusercontent.com/Rdatatable/data.table/master/.graphics/logo.png">the defining feature of data.table</a>).</p>
<p>R’s own use of <code>TRUELENGTH</code> is <a href="https://cran.r-project.org/doc/manuals/R-ints.html#The-_0027data_0027">varied</a>. The field itself appeared in <a href="https://github.com/r-devel/r-svn/commit/2d4ae2c4bd593bc2aa2273076997b6e63bbcb782">R-0.63</a> together with the <code>VECSXP</code> lists (to replace the Lisp-style linked pairlists). R <a href="https://github.com/r-devel/r-svn/blob/04a3b015e7d20598f66954b88ae2d39068451494/src/include/Defn.h#L1184-L1187">uses this field</a> in <code>CHARSXP</code> strings to store the hash values <a href="https://github.com/r-devel/r-svn/blob/04a3b015e7d20598f66954b88ae2d39068451494/src/main/names.c#L1256-L1272">belonging to symbols</a>. R’s many <code>VECSXP</code>-based hash tables use it to count the primary slots in use: hashes are used for reference tracking during (un)serialization (<a href="https://github.com/r-devel/r-svn/blob/04a3b015e7d20598f66954b88ae2d39068451494/src/main/serialize.c#L617-L634">1</a>, <a href="https://github.com/r-devel/r-svn/blob/04a3b015e7d20598f66954b88ae2d39068451494/src/main/saveload.c#L807-L834">2</a>) and looking up environment contents (<a href="https://github.com/r-devel/r-svn/blob/04a3b015e7d20598f66954b88ae2d39068451494/src/main/envir.c#L193-L207">1</a>, <a href="https://github.com/r-devel/r-svn/blob/04a3b015e7d20598f66954b88ae2d39068451494/src/main/envir.c#L497-L520">2</a>). R-3.3 (May 2016) saw the inclusion of <a href="https://github.com/r-devel/r-svn/commit/4907092c953bd0b9c059474f77e40990ecf312b1">radix sort</a> from <code>data.table</code> itself, which <a href="#TRUELENGTH-mark">uses <code>TRUELENGTH</code> to sort strings</a>. R-3.4 (April 2017) <a href="https://github.com/r-devel/r-svn/commit/287b8316232aea7c619d0cadcb515507b1e3ebfa">introduced</a> over-allocation when growing vectors due to assignment outside their bounds. The <a href="https://github.com/r-devel/r-svn/blob/c9437a83b9677074fe01310caac6a2a66cc7f680/src/include/Defn.h#L373-L377">growable bit</a> was added to prevent the mismanagement of the allocated memory counter: without the bit set on the over-allocated vectors, the garbage collector only counted <code>LENGTH(x)</code> instead of <code>TRUELENGTH(x)</code> units as released when garbage-collecting the vector, inflating the counter over time. <a href="https://svn.r-project.org/R/branches/ALTREP/ALTREP.html">ALTREP</a> objects introduced in R-3.5 (April 2018) don’t have a <code>TRUELENGTH</code>: it <a href="https://github.com/r-devel/r-svn/blob/04a3b015e7d20598f66954b88ae2d39068451494/src/include/Defn.h#L391">cannot be set</a> and is <a href="https://github.com/r-devel/r-svn/blob/04a3b015e7d20598f66954b88ae2d39068451494/src/main/altrep.c#L345">returned as 0</a>. In very old versions of R, <code>TRUELENGTH</code> wasn’t initialised, but it is nowadays set to 0, which <code>data.table</code> <a href="https://github.com/Rdatatable/data.table/blob/03c647f9a44710aad834c0718e0b34e8c5341bf1/src/init.c#L206">depends upon</a>.</p>
<p>Nowadays, <code>data.table</code> uses vectors whose length is different from their allocated size in many places:</p>
<ul>
<li><code>src/dogroups.c</code>
<ul>
<li>reuses the same memory for the <a href="https://github.com/Rdatatable/data.table/blob/03c647f9a44710aad834c0718e0b34e8c5341bf1/src/dogroups.c#L197"><code>data.table</code> subset object <code>.SD</code></a> and for the <a href="https://github.com/Rdatatable/data.table/blob/03c647f9a44710aad834c0718e0b34e8c5341bf1/src/dogroups.c#L230-L237">virtual row number column <code>.I</code></a> by shortening the vectors to the size of the current group</li>
<li>later <a href="https://github.com/Rdatatable/data.table/blob/03c647f9a44710aad834c0718e0b34e8c5341bf1/src/dogroups.c#L482-L485">restores their natural length</a></li>
<li><a href="https://github.com/Rdatatable/data.table/blob/03c647f9a44710aad834c0718e0b34e8c5341bf1/src/dogroups.c#L318-L324">extends the <code>data.table</code> for new columns</a> as needed</li>
</ul></li>
<li><code>src/freadR.c</code>
<ul>
<li>works with an over-estimated line count and so can <a href="https://github.com/Rdatatable/data.table/blob/03c647f9a44710aad834c0718e0b34e8c5341bf1/src/freadR.c#L536-L538">truncate the columns</a> after the value is known precisely
<ul>
<li>the columns are <a href="https://github.com/Rdatatable/data.table/blob/03c647f9a44710aad834c0718e0b34e8c5341bf1/src/freadR.c#L519">prepared to be truncated</a></li>
</ul></li>
<li>may also <a href="https://github.com/Rdatatable/data.table/blob/03c647f9a44710aad834c0718e0b34e8c5341bf1/src/freadR.c#L551-L552">drop columns by reference</a></li>
</ul></li>
<li><code>src/subset.c</code>
<ul>
<li>the <code>subsetDT</code> function <a href="https://github.com/Rdatatable/data.table/blob/03c647f9a44710aad834c0718e0b34e8c5341bf1/src/subset.c#L300-L334">prepares an over-allocated <code>data.table</code></a> together with its names.</li>
</ul></li>
<li><code>src/assign.c</code>
<ul>
<li>the <code>shallow</code> function <a href="https://github.com/Rdatatable/data.table/blob/03c647f9a44710aad834c0718e0b34e8c5341bf1/src/assign.c#L192-L196">prepares</a> an over-allocated <code>data.table</code> referencing the columns of an existing <code>data.table</code></li>
<li><code>assign</code> <a href="https://github.com/Rdatatable/data.table/blob/03c647f9a44710aad834c0718e0b34e8c5341bf1/src/assign.c#L535-L536">creates</a> or <a href="https://github.com/Rdatatable/data.table/blob/03c647f9a44710aad834c0718e0b34e8c5341bf1/src/assign.c#L733-L734">removes</a> columns by reference</li>
<li><code>finalizer</code> causes an <code>INTSXP</code> vector <a href="https://github.com/Rdatatable/data.table/blob/03c647f9a44710aad834c0718e0b34e8c5341bf1/src/assign.c#L21">with the fake length</a> to be (eventually) garbage-collected to fix up a discrepancy in R’s vector size accounting caused by the existence of the over-allocated <code>data.table</code></li>
</ul></li>
</ul>
<p><code>SETLENGTH</code> presents many opportunities to create inconsistencies within R:</p>
<ul>
<li>When copying shortened objects without the <code>GROWABLE_BIT</code> set, R allocates and copies only <code>XLENGTH</code> elements and <a href="https://github.com/r-devel/r-svn/blob/04a3b015e7d20598f66954b88ae2d39068451494/src/main/duplicate.c#L43-L81">duplicates the value of <code>TRUELENGTH</code></a>.
<ul>
<li>For this and other reasons, <code>data.table</code>s have a special <a href="https://github.com/Rdatatable/data.table/blob/03c647f9a44710aad834c0718e0b34e8c5341bf1/src/assign.c#L27-L63"><code>.internal.selfref</code> attribute</a> attached containing an <code>EXTPTR</code> back to itself. A copy of a table can be detected because it will have a different address.
<ul>
<li>The <code>_selfrefok</code> function tries to <a href="https://github.com/Rdatatable/data.table/blob/03c647f9a44710aad834c0718e0b34e8c5341bf1/src/assign.c#L99-L138">restore the correct <code>TRUELENGTH</code></a> if it detects a copy.</li>
</ul></li>
<li>Setting the <code>GROWABLE_BIT</code> on the <code>data.table</code> would make R keep the default <code>TRUELENGTH</code> (0) instead of copying it.</li>
</ul></li>
<li>When deallocating shortened objects without the <code>GROWABLE_BIT</code> set, R <a href="https://github.com/r-devel/r-svn/blob/04a3b015e7d20598f66954b88ae2d39068451494/src/main/memory.c#L1108-L1109">accounts only for the <code>XLENGTH</code> elements</a> being released, over-counting the total amount of allocated memory.
<ul>
<li><code>data.table</code> compensates for this using the <a href="https://github.com/Rdatatable/data.table/blob/03c647f9a44710aad834c0718e0b34e8c5341bf1/src/assign.c#L21"><code>finalizer</code></a> on the <code>.internal.selfrep</code> attribute.</li>
<li>Setting the <code>GROWABLE_BIT</code> on the <code>data.table</code> would make R account for <code>TRUELENGTH</code> elements instead of <code>XLENGTH</code> elements.</li>
</ul></li>
</ul>
<p>Unfortunately, <code>GROWABLE_BIT</code> is not part of the API and was only introduced in R-3.4, so it does not present a full solution to the problems. Moreover,</p>
<ul>
<li><p>Setting <code>LENGTH</code> larger than the allocated length may cause R to access undefined or even unmapped memory.</p></li>
<li><p>For vectors containing other <code>SEXP</code> values (of type <code>VECSXP</code>, <code>EXPRSXP</code>, <code>STRSXP</code>): when reducing the <code>LENGTH</code>, having a non-persistent value (something unlike the persistent values <code>R_NilValue</code> or <code>R_BlankString</code> or <code>R_NaString</code> provided by R itself) in the newly inaccessible cells will also make them unreachable from the viewpoint of the garbage collector, potentially prompting it to reuse or unmap the pointed-to memory. Increasing the <code>LENGTH</code> again with invalid pointers in the newly accessible slots will make an invalid vector that cannot be safely altered or discarded:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;R.h&gt;</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rinternals.h&gt;</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> foo<span class="op">(</span><span class="dt">void</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    SEXP list <span class="op">=</span> PROTECT<span class="op">(</span>allocVector<span class="op">(</span>VECSXP<span class="op">,</span> <span class="dv">100</span><span class="op">)),</span> elt<span class="op">;</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    SET_VECTOR_ELT<span class="op">(</span>list<span class="op">,</span> <span class="dv">99</span><span class="op">,</span> elt <span class="op">=</span> allocVector<span class="op">(</span>REALSXP<span class="op">,</span> <span class="dv">1000</span><span class="op">));</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> <span class="op">*</span> p <span class="op">=</span> REAL<span class="op">(</span>elt<span class="op">);</span> <span class="co">// initialise the vector</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>R_xlen_t i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> xlength<span class="op">(</span>elt<span class="op">);</span> <span class="op">++</span>i<span class="op">)</span> p<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> i<span class="op">;</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    SETLENGTH<span class="op">(</span>list<span class="op">,</span> <span class="dv">1</span><span class="op">);</span> <span class="co">// elt is unreachable</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    R_gc<span class="op">();</span> <span class="co">// elt is collected</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    SETLENGTH<span class="op">(</span>list<span class="op">,</span> <span class="dv">100</span><span class="op">);</span> <span class="co">// invalid elt is reachable again</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    R_gc<span class="op">();</span> <span class="co">// invalid elt is accessed</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    UNPROTECT<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>  R_gc<span class="op">();</span> <span class="co">// crash here if not above</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul>
<p><a href="https://bugs.r-project.org/show_bug.cgi?id=17620">Starting with R-4.3</a>, R packages can implement their own <code>VECSXP</code>-like objects using the <a href="https://svn.r-project.org/R/branches/ALTREP/ALTREP.html">ALTREP</a> framework; <code>STRSXP</code> objects have been supported since R-3.5. An <code>ALTREP</code> object is defined by its <em>class</em> (a collection of methods) and two arbitrary R values, <code>data1</code> and <code>data2</code>. (Attributes are not a part of the ALTREP representation and exist the same way as on normal R objects.) A simple implementation of a shortened, expandable vector could hold a full-length vector in the <code>data1</code> slot and its pretend-length as a one-element <code>REALSXP</code> value in the <code>data2</code> slot. (Currently, <code>R_xlen_t</code> values are limited by the largest integer precisely representable in an IEEE <code>double</code> value, which is <span class="math inline">\(2^{52}\)</span>.) The over-allocated class will need to implement the following methods:</p>
<ul>
<li><a href="https://aitap.codeberg.page/R-api/#R_005fset_005faltrep_005f_002e_002e_002e_005fmethod">Common ALTREP methods</a>:
<ul>
<li><code>Length()</code>, returning the pretend-length of the vector. Required.</li>
<li><code>Duplicate(deep)</code>. If not implemented, R will create a copy as an ordinary object using the length and the data pointer provided by the class.
<ul>
<li>There is also <code>DuplicateEX(deep)</code>, which is responsible for copying the value <em>and</em> the attributes, but it may be hard to implement within the API bounds (<code>ATTRIB</code> is not API), and R provides a default implementation that calls <code>Duplicate</code> above.</li>
<li>Shared mutable vectors <a href="https://github.com/ALTREP-examples/Rpkg-mutable/blob/master/vignettes/mutable.Rmd">can cause problems</a>, so a decision to let the <code>Duplicate()</code> return value share the original vector will require a lot of thought and testing.</li>
</ul></li>
<li><code>Serialized_state()</code>, <code>Unserialize(state)</code>. If not implemented, R will serialize the value as an ordinary object, which is what currently happens for <code>data.table</code>s. Once an R package implements an ALTREP class with a <code>Serialized_state</code> method, the format is set in stone; any changes will have to introduce a new class.
<ul>
<li>Similarly, there is <code>UnserializeEX(state, attr, objf, levs)</code> responsible for setting <code>LEVELS</code>, the object bit, and the attributes; the default implementation should suffice.</li>
</ul></li>
<li><code>Inspect(pre, deep, pvec, inspect_subtree)</code>. May <code>Rprintf</code> some information from the ALTREP fields before returning <code>FALSE</code> to let R continue <code>inspect</code>ing the object.</li>
</ul></li>
<li><a href="https://aitap.codeberg.page/R-api/#R_005fset_005faltvec_005f_002e_002e_002e_005fmethod">Common <code>altvec</code> methods</a> required for most code to work with the class:
<ul>
<li><code>Dataptr(writable)</code>, returning the pointer to the start of the array backing the underlying vector. For <code>VECSXP</code> or <code>STRSXP</code> vectors, <code>writable</code> should always be <code>FALSE</code>, so <code>DATAPTR_RO</code> can be used.</li>
<li><code>Dataptr_or_null()</code>. May delegate to <code>Dataptr(FALSE)</code> above.</li>
<li><code>Extract_subset(indx, call)</code>. Must allocate and return <code>x[indx]</code> for 1-based numeric <code>indx</code> that may be outside the bounds of <code>x</code>.</li>
</ul></li>
<li>Class-specific methods:
<ul>
<li><a href="https://aitap.codeberg.page/R-api/#R_005fmake_005faltstring_005fclass"><code>altstring</code> methods</a>:
<ul>
<li><code>Elt(i)</code>. Must return <code>x[[i]]</code> for 0-based <code>i</code> or signal an error. Required.</li>
<li><code>Set_elt(i, v)</code>. Must perform <code>x[[i]] &lt;- v</code> for 0-based <code>i</code> or signal an error. Required.</li>
<li><code>Is_sorted()</code>. If not implemented, will always return <code>UNKNOWN_SORTEDNESS</code>.</li>
<li><code>No_NA()</code>. If not implemented, will always return 0 (unknown whether contains missing values).</li>
</ul></li>
<li><a href="https://aitap.codeberg.page/R-api/#R_005fmake_005faltlist_005fclass"><code>altlist</code> methods</a>:
<ul>
<li><code>Elt(i)</code> and <code>Set_elt(i, v)</code> like above.</li>
</ul></li>
<li>The rest of the atomic vector types (<a href="https://aitap.codeberg.page/R-api/#R_005fmake_005faltinteger_005fclass">integer</a>, <a href="https://aitap.codeberg.page/R-api/#R_005fmake_005faltlogical_005fclass">logical</a>, <a href="https://aitap.codeberg.page/R-api/#R_005fmake_005faltreal_005fclass">numeric</a>, <a href="https://aitap.codeberg.page/R-api/#R_005fmake_005faltcomplex_005fclass">complex</a>, <a href="https://aitap.codeberg.page/R-api/#R_005fmake_005faltraw_005fclass">raw</a>) will each need a subset of the following methods:
<ul>
<li><code>Elt(i)</code>, <code>Is_sorted()</code>, <code>No_NA()</code>, as above.</li>
<li><code>Get_region(i, n, buf)</code> to populate the buffer <code>buf[n]</code> of the corresponding C type with elements at the given 0-based indices <code>i</code>. The indices are not guaranteed to be within bounds; the number of actually copied elements must be returned. If not implemented, R will use the <code>Elt(i)</code> method, which is slower.</li>
<li><code>Sum(narm)</code>, <code>Min(narm)</code>, <code>Max(narm)</code> to compute a summary of the vector, optionally ignoring the missing values. If not implemented, R will use <code>Get_region</code> to compute the summaries.</li>
</ul></li>
</ul></li>
</ul>
<p>Additionally, <code>data.table</code> will need a function to <a href="https://aitap.codeberg.page/R-api/#R_005fnew_005faltrep">create new ALTREP tables</a> and to resize the vector in place. The resize function will need to check whether the given value <a href="https://aitap.codeberg.page/R-api/#index-R_005faltrep_005finheritsaltrep_005finherits"><code>R_altrep_inherits</code></a> from the over-allocated class and then modify the ALTREP data slots as needed. The function may even reallocate the payload to enlarge the vector in place past the original allocation limit without requiring a <code>setDT</code> call from the user. Since a reallocation will invalidate the data pointer, it must be only used from inside <code>data.table</code>, not from the ALTREP methods.</p>
<p>The original implementation that uses <code>SETLENGTH</code> can be kept behind <code>#if R_VERSION &lt; R_Version(4, 3, 0)</code> for backwards compatibility.</p>
<p>Replacing <code>TRUELENGTH</code>-based growable vectors with <code>ALTREP</code>-based ones will conform to the API, allow growing the vector in place, and avoid the various inconsistencies that happen when R duplicates or deallocates these vectors, but also has the following downsides:</p>
<ul>
<li>Every place in <code>data.table</code> that uses growable vectors will have to be refactored to use the new abstraction layer (<code>SETLENGTH</code> in R &lt; 4.3, ALTREP in R ≥ 4.3).
<ul>
<li>Both implementations will have to be maintained as long as <code>data.table</code> supports R &lt; 4.3.</li>
<li>The current implementation in <code>data.table</code> re-creates ALTREP objects as ordinary ones precisely because it’s impossible to <code>SET_TRUELENGTH</code> on ALTREP objects. This will also need to be refactored.</li>
</ul></li>
<li>The data pointer access is slower for ALTREP vectors than for ordinary vectors: having checked the ALTREP bit in the header, R will have to access the method table and call the method instead of adding a fixed offset to the original <code>SEXP</code> pointer. This shouldn’t be noticeable unless <code>data.table</code> puts data pointer access inside a “hot” loop.</li>
<li>For numeric ALTREP classes, ALTREP-aware operations that use <code>*_GET_REGION</code> instead of the data pointer will become slower unless the class implements a <code>Get_region</code> method.</li>
</ul>
<p><strong>Status</strong> in <code>data.table</code>: not fixed yet.</p>
</section>
<section id="TRUELENGTH-mark" class="level3">
<h3 class="anchored" data-anchor-id="TRUELENGTH-mark">Fast string matching</h3>
<p><code>data.table</code>’s use of <code>TRUELENGTH</code> is not limited to growable buffers. A common idiom is to set the <code>TRUELENGTH</code>s of <code>CHARSXP</code> values from a vector to their negative 1-based indices in that vector, then look up other <code>CHARSXP</code>s in the original vector using <code>-TRUELENGTH(s)</code>. This technique relies on <a href="https://cran.r-project.org/doc/manuals/R-ints.html#The-CHARSXP-cache">R’s <code>CHARSXP</code> cache</a>: for the given string contents and encoding, only one copy of a string created by <code>mkCharLenCE</code> (and related functions) will exist in the memory. As a result, if a string does exist in the original vector, it will be the <em>same</em> <code>CHARSXP</code> object whose <code>TRUELENGTH</code> had been set to its negative index. R does not currently set negative <code>TRUELENGTH</code>s by itself, so any positive <code>TRUELENGTH</code>s can be safely discarded as non-matches.</p>
<p>In the best case scenario, this lookup is very fast: for a table of size <span class="math inline">\(n\)</span> and <span class="math inline">\(k\)</span> strings to look up in it, it takes <span class="math inline">\(\mathrm{O}(1)\)</span> memory (the <code>TRUELENGTH</code> is already there, unused) and <span class="math inline">\(\mathrm{O}(n)\)</span> time for overhead plus <span class="math inline">\(\mathrm{O}(k)\)</span> time for the actual lookups.</p>
<p>Care must be taken for the technique to work properly:</p>
<ul>
<li><p>The strings must be converted to UTF-8. Two copies of the same text in different encodings will be stored in different objects at different addresses, preventing the technique from working:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">packageVersion</span>(<span class="st">'data.table'</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co"># [1] ‘1.16.99’</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="fu">factor</span>(<span class="fu">rep</span>(<span class="fu">enc2utf8</span>(<span class="st">'ø'</span>), <span class="dv">3</span>)))</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co"># memrecycle() forgot to account for encodings</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>x[<span class="dv">1</span>,V1 <span class="sc">:</span><span class="er">=</span> <span class="fu">iconv</span>(<span class="st">'ø'</span>, <span class="at">to=</span><span class="st">'latin1'</span>)]</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="fu">as.numeric</span>(x<span class="sc">$</span>V1)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co"># [1] 2 1 1</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="fu">levels</span>(x<span class="sc">$</span>V1) <span class="co"># duplicated levels!</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="co"># [1] "ø" "ø"</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="fu">identical</span>(<span class="fu">levels</span>(x<span class="sc">$</span>V1)[[<span class="dv">1</span>]], <span class="fu">levels</span>(x<span class="sc">$</span>V1)[[<span class="dv">2</span>]])</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="co"># [1] TRUE</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="fu">levels</span>(x<span class="sc">$</span>V1) <span class="ot">&lt;-</span> <span class="fu">levels</span>(x<span class="sc">$</span>V1)</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="fu">levels</span>(x<span class="sc">$</span>V1) <span class="co"># R restores unique levels</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="co"># [1] "ø"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Any non-zero <code>TRUELENGTH</code> values resulting from R-internal usage must be <a href="https://github.com/Rdatatable/data.table/blob/03c647f9a44710aad834c0718e0b34e8c5341bf1/src/assign.c#L1274-L1328">saved</a> beforehand and restored afterwards.</p></li>
<li><p>The <code>TRUELENGTH</code>s are used to look up variables in hashed environments, so R code should not run while the values are disturbed.</p></li>
</ul>
<p>The encoding conversions take <span class="math inline">\(\mathrm{O}(n+k)\)</span> time and space; the <code>TRUELENGTH</code> bookkeeping takes <span class="math inline">\(\mathrm{O}(n)\)</span> space and time (thanks to the exponential <code>realloc</code> trick).</p>
<p>The fast string lookup is used in the following places:</p>
<ul>
<li><code>src/assign.c</code>: <a href="https://github.com/Rdatatable/data.table/blob/03c647f9a44710aad834c0718e0b34e8c5341bf1/src/assign.c#L833-L867">factor level merging in <code>memrecycle</code></a>, <a href="https://github.com/Rdatatable/data.table/blob/03c647f9a44710aad834c0718e0b34e8c5341bf1/src/assign.c#L1274-L1328"><code>savetl</code> helper</a></li>
<li><code>src/rbindlist.c</code>: <a href="https://github.com/Rdatatable/data.table/blob/03c647f9a44710aad834c0718e0b34e8c5341bf1/src/rbindlist.c#L70-L179">matching column names</a>, <a href="https://github.com/Rdatatable/data.table/blob/03c647f9a44710aad834c0718e0b34e8c5341bf1/src/rbindlist.c#L367-L516">matching factor levels</a></li>
<li><code>src/forder.c</code>: (different purpose, same technique) <a href="https://github.com/Rdatatable/data.table/blob/03c647f9a44710aad834c0718e0b34e8c5341bf1/src/forder.c#L769">storing the group numbers</a>, <a href="https://github.com/Rdatatable/data.table/blob/03c647f9a44710aad834c0718e0b34e8c5341bf1/src/forder.c#L769">looking them up</a>, <a href="https://github.com/Rdatatable/data.table/blob/03c647f9a44710aad834c0718e0b34e8c5341bf1/src/forder.c#L75">restoring the original values</a></li>
<li><code>src/chmatch.c</code>: <a href="https://github.com/Rdatatable/data.table/blob/03c647f9a44710aad834c0718e0b34e8c5341bf1/src/chmatch.c#L58-L64">saving the original <code>TRUELENGTH</code>s</a>, <a href="https://github.com/Rdatatable/data.table/blob/03c647f9a44710aad834c0718e0b34e8c5341bf1/src/chmatch.c#L78-L80">remembering the positions of <code>CHARSXP</code>s in the table</a>, <a href="https://github.com/Rdatatable/data.table/blob/03c647f9a44710aad834c0718e0b34e8c5341bf1/src/chmatch.c#L103">cleaning up on error</a>, <a href="https://github.com/Rdatatable/data.table/blob/03c647f9a44710aad834c0718e0b34e8c5341bf1/src/chmatch.c#L108-L130">looking up strings in the table</a>, <a href="https://github.com/Rdatatable/data.table/blob/03c647f9a44710aad834c0718e0b34e8c5341bf1/src/chmatch.c#L135-L136">cleaning up before exit</a></li>
<li><code>src/fmelt.c</code>: <a href="https://github.com/Rdatatable/data.table/blob/03c647f9a44710aad834c0718e0b34e8c5341bf1/src/utils.c#L273">combining factor levels by merging their <code>CHARSXP</code>s in a common array with indices in <code>TRUELENGTH</code></a></li>
</ul>
<p>Since there doesn’t seem to be any intent to allow using R API to place arbitrary integer values inside unused <code>SEXP</code> fields, <code>data.table</code> will have to look up the <code>CHARSXP</code> values using the externally available information. Performing <span class="math inline">\(\mathrm{O}(nk)\)</span> direct pointer comparisons would scale poorly, so for an <span class="math inline">\(\mathrm{O}(1)\)</span> individual lookup <code>data.table</code> could build a hash table of <code>SEXP</code> pointers. While pointer hashing <a href="https://nullprogram.com/blog/2016/05/30/">isn’t strictly guaranteed by the C standard to work</a>, it has been used <a href="https://github.com/r-devel/r-svn/blob/3713345283787c928e563cdcdf01cc4a9dc1c708/src/main/unique.c#L185-L208">in R itself</a>. A hash table for <span class="math inline">\(n\)</span> <code>CHARSXP</code> pointers would need <span class="math inline">\(\mathrm{O}(n)\)</span> memory, <span class="math inline">\(\mathrm{O}(n)\)</span> time to initialise, and average <span class="math inline">\(\mathrm{O}(k)\)</span> time for <span class="math inline">\(k\)</span> lookups <span class="citation" data-cites="Cormen2009">(<a href="#ref-Cormen2009" role="doc-biblioref">Cormen et al. 2009, chap. 11</a>)</span>.</p>
<p>Taking the <code>savetl</code> bookkeeping into account, the <em>average asymptotic</em> performance of <code>TRUELENGTH</code> and hashing for string lookup is the same in both time and space, but the constants are most likely lower for <code>TRUELENGTH</code>. Transitioning to a hash will probably involve a performance hit.</p>
<p>A truly lazy implementation could just use <a href="https://en.cppreference.com/w/cpp/container/unordered_map"><code>std::unordered_map&lt;SEXP, int&gt;</code></a> (at the cost of requiring C++11, which was supported but far from required in R-3.3, and having to shield R from the C++ exceptions) or the permissively-licensed <a href="https://troydhanson.github.io/uthash/">uthash</a>. Since the upper bound on the size of the table is known ahead of time, a custom-made open-addressing hash table <span class="citation" data-cites="Cormen2009">(<a href="#ref-Cormen2009" role="doc-biblioref">Cormen et al. 2009, sec. 11.4</a>)</span> could be implemented with a fixed load factor, requiring only one allocation and no linked lists to walk.</p>
<p><strong>Status</strong> in <code>data.table</code>: not fixed yet.</p>
</section>
<section id="marking-columns-for-copying" class="level3">
<h3 class="anchored" data-anchor-id="marking-columns-for-copying">Marking columns for copying</h3>
<p>The use of <code>TRUELENGTH</code> in <code>data.table</code> to mark objects is not limited to <code>CHARSXP</code> strings. Individual columns are also marked in a similar manner for later copying:</p>
<ul>
<li>In <code>src/dogroups.c</code>, the vectors allocated for the special symbols <code>.BY</code>, <code>.I</code>, <code>.N</code>, <code>.GRP</code> must not be returned by the grouping operations evaluated with <code>dt[..., ..., by=...]</code>, so they are <a href="https://github.com/Rdatatable/data.table/blob/03c647f9a44710aad834c0718e0b34e8c5341bf1/src/dogroups.c#L105-L152">marked with a <code>TRUELENGTH</code> of -1</a>, and the <a href="https://github.com/Rdatatable/data.table/blob/03c647f9a44710aad834c0718e0b34e8c5341bf1/src/dogroups.c#L6-L64">marked columns</a> are later re-created.</li>
<li>In <code>src/utils.c</code>, columns share memory or are ALTREP must be copied. Memory sharing between columns may lead to confusing results when they are altered by reference, and ALTREP columns cannot have <code>TRUELENGTH</code> set. The code uses the same trick as with <code>CHARSXP</code> objects: if <code>TRUELENGTH</code> is set on an object, accessing it through a different pointer and seeing a non-zero value will prove that the object had been previously visited. The code first <a href="https://github.com/Rdatatable/data.table/blob/03c647f9a44710aad834c0718e0b34e8c5341bf1/src/utils.c#L260-L261">prepares zero <code>TRUELENGTH</code>s</a>, then <a href="https://github.com/Rdatatable/data.table/blob/03c647f9a44710aad834c0718e0b34e8c5341bf1/src/utils.c#L266-L267">marks ALTREP, special, and already marked columns for copying</a>, then <a href="https://github.com/Rdatatable/data.table/blob/03c647f9a44710aad834c0718e0b34e8c5341bf1/src/utils.c#L273">marks columns not previously marked with their column number</a>, then finally <a href="https://github.com/Rdatatable/data.table/blob/03c647f9a44710aad834c0718e0b34e8c5341bf1/src/utils.c#L273">restores the <code>TRUELENGTH</code>s for the columns that won’t be overwritten</a>.
<ul>
<li>The <code>SET_TRUELENGTH</code> call in <code>copySharedColumns</code> would fail if it ever got an ALTREP column, but the only use of <code>copySharedColumns</code> in <code>reorder</code> guards against those.</li>
</ul></li>
</ul>
<p>The same solution as <a href="#TRUELENGTH-mark">above</a> can be used here, with the same downsides of having to allocate memory for the hash table and the potential to have worst-case <span class="math inline">\(\mathrm{O}(kn)\)</span> time for <span class="math inline">\(k\)</span> lookups fundamental to hash tables.</p>
<p><strong>Status</strong> in <code>data.table</code>: not fixed yet.</p>
</section>
</section>
</section>
<section id="but-theres-more" class="level1">
<h1>But there’s more</h1>
<p>Using <code>tools:::funAPI</code> together with the lists of symbols exported from R and imported by <code>data.table</code>, we can find a number of non-API entry points which <code>R CMD check</code> doesn’t complain about yet: <code>ATTRIB</code>, <code>findVar</code>, <code>GetOption</code>, <code>isFrame</code>, <code>OBJECT</code>, <code>SET_ATTRIB</code>, <code>SET_OBJECT</code>.</p>
<section id="ATTRIB-all" class="level2">
<h2 class="anchored" data-anchor-id="ATTRIB-all"><code>(SET_)ATTRIB</code>, <code>SET_OBJECT</code></h2>
<p><code>data.table</code> performs some direct operations on the attribute pairlists. Accessing attributes directly requires manually maintaining the object bit.</p>
<blockquote class="blockquote">
<p>Use <code>getAttrib</code> for individual attributes. To test whether there are any attributes use <code>ANY_ATTRIB</code>, added in R 4.5.0. Use <code>setAttrib</code> for individual attributes, <code>DUPLICATE_ATTRIB</code> or <code>SHALLOW_DUPLICATE_ATTRIB</code> for copying attributes from one object to another. Use <code>CLEAR_ATTRIB</code> for removing all attributes, added in R 4.5.0.</p>
</blockquote>
<p>– <a href="https://cran.r-project.org/doc/manuals/r-devel/R-exts.html#Some-API-replacements-for-non_002dAPI-entry-points">WRE 6.21.1</a></p>
<section id="testing-for-presence-of-attributes" class="level3">
<h3 class="anchored" data-anchor-id="testing-for-presence-of-attributes">Testing for presence of attributes</h3>
<p><code>src/nafill.c</code> <a href="https://github.com/Rdatatable/data.table/blob/546259ddaba0e8ab1506729113688f85ca2986fd/src/nafill.c#L216">checks</a> whether the source object has any attributes before trying to copy them using <code>copyMostAttrib</code>.</p>
<p>Problem:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(!</span>isNull<span class="op">(</span>ATTRIB<span class="op">(</span>VECTOR_ELT<span class="op">(</span>x<span class="op">,</span> i<span class="op">))))</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>         <span class="co">// ^^^^^^ non-API entry point</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Solution:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#if R_VERSION &lt; R_Version(4, 5, 0)</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#define ANY_ATTRIB</span><span class="op">(</span><span class="pp">x</span><span class="op">)</span><span class="pp"> </span><span class="op">(!</span><span class="pp">isNull</span><span class="op">(</span><span class="pp">ATTRIB</span><span class="op">(</span><span class="pp">x</span><span class="op">)))</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>ANY_ATTRIB<span class="op">(</span>VECTOR_ELT<span class="op">(</span>x<span class="op">,</span> i<span class="op">)))</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a> <span class="co">// ^^^^^^^^^^ introduced in R-4.5</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Status</strong> in <code>data.table</code>: not fixed yet. Will need to wait for R-4.5.0 to be released with the new interface.</p>
</section>
<section id="iterating-over-all-attributes" class="level3">
<h3 class="anchored" data-anchor-id="iterating-over-all-attributes">Iterating over all attributes</h3>
<ul>
<li>The code in <code>src/assign.c</code> needs to <a href="https://github.com/Rdatatable/data.table/blob/03c647f9a44710aad834c0718e0b34e8c5341bf1/src/assign.c#L618-L629">iterate over all the attributes of <code>attr(dt, 'index')</code></a> in order to find indices that use the given column.</li>
<li>The code in <code>src/dogroups.c</code> needs to <a href="https://github.com/Rdatatable/data.table/blob/03c647f9a44710aad834c0718e0b34e8c5341bf1/src/dogroups.c#L57-L58">iterate over all attributes of a column</a> in case a reference to the value of a special symbol has been stashed there and must be duplicated.</li>
</ul>
<p>Without <code>ATTRIB</code>, this will only be possible using an R-level call to <code>attributes()</code>. While the indices could be changed to use a different data structure (a named <code>VECSXP</code> list?), necessitating an update step for <code>data.table</code>s loaded from storage, the code in <code>src/dogroups.c</code> cannot avoid having to see all the attributes.</p>
<p><strong>Status</strong> in <code>data.table</code>: no idea how to fix yet.</p>
</section>
<section id="raw-cna-n-row-names" class="level3">
<h3 class="anchored" data-anchor-id="raw-cna-n-row-names">Raw <code>c(NA, n)</code> row names</h3>
<p>The code in <code>src/dogroups.c</code> needs to <a href="https://github.com/Rdatatable/data.table/blob/03c647f9a44710aad834c0718e0b34e8c5341bf1/src/dogroups.c#L131-L134">access the raw <code>rownames</code> attribute</a> of a <code>data.table</code>, even if it’s in the compact form as a 2-element integer vector starting with <code>NA</code>. The <code>getAttrib</code> function has a special case for the <code>R_RowNamesSymbol</code>, which returns an ALTREP representation of this attribute.</p>
<p><code>data.table</code> needs this access in order to <a href="https://github.com/Rdatatable/data.table/blob/03c647f9a44710aad834c0718e0b34e8c5341bf1/src/dogroups.c#L195">temporarily overwrite</a> the <code>rownames</code> attribute for the specially-prepared subset <code>data.table</code> named <code>.SD</code> (which has a different number of rows and therefore needs different <code>rownames</code>). Creating a full-sized <code>rownames</code> attribute instead of its compact form would take more time than desirable.</p>
<p><strong>Status</strong> in <code>data.table</code>: no idea how to fix yet.</p>
</section>
<section id="direct-transplantation-of-attributes" class="level3">
<h3 class="anchored" data-anchor-id="direct-transplantation-of-attributes">Direct transplantation of attributes</h3>
<p>The code in <code>src/dogroups.c</code> needs to <a href="https://github.com/Rdatatable/data.table/blob/03c647f9a44710aad834c0718e0b34e8c5341bf1/src/dogroups.c#L509-L515">transplant</a> the attributes from one object to another without duplicating them, even shallowly. <code>SHALLOW_DUPLICATE_ATTRIB</code> could work as a replacement, but with worse performance because it would waste time copying attributes from an object that is about to be discarded.</p>
<p><strong>Status</strong> in <code>data.table</code>: no idea how to fix yet.</p>
</section>
</section>
<section id="findvar" class="level2">
<h2 class="anchored" data-anchor-id="findvar"><code>findVar</code></h2>
<p><a href="https://github.com/Rdatatable/data.table/blob/03c647f9a44710aad834c0718e0b34e8c5341bf1/src/dogroups.c#L90-L118">Used in <code>dogroups</code></a> to look up the pre-created variables corresponding to the special symbols <code>.SDall</code>, <code>.SD</code>, <code>.N</code>, <code>.GRP</code>, <code>.iSD</code>, <code>.xSD</code> in their environment.</p>
<blockquote class="blockquote">
<p>The functions <code>findVar</code> and <code>findVarInFrame</code> have been used in a number of packages but are too low level to be part of the API. For most uses the functions <code>R_getVar</code> and <code>R_getVarEx</code> added in R 4.5.0 will be sufficient. These are analogous to the R functions <code>get</code> and <code>get0</code>.</p>
</blockquote>
<p>– <a href="https://cran.r-project.org/doc/manuals/r-devel/R-exts.html#Working-with-variable-bindings">WRE 6.21.7</a></p>
<p>The new function <code>R_getVar</code> is different in that it will never return a <code>PROMSXP</code> (which are an internal implementation detail) or an <code>R_UnboundValue</code>, but the current code doesn’t try to care about either.</p>
<p>Example of the problem:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>SEXP SD <span class="op">=</span> PROTECT<span class="op">(</span>findVar<span class="op">(</span>install<span class="op">(</span><span class="st">".SD"</span><span class="op">),</span> env<span class="op">));</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>               <span class="co">// ^^^^^^^ non-API function</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Solution:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#if R_VERSION &lt; R_Version(4, 5, 0)</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#define R_getVar</span><span class="op">(</span><span class="pp">sym</span><span class="op">,</span><span class="pp"> rho</span><span class="op">,</span><span class="pp"> inherits</span><span class="op">)</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="pp"> </span><span class="op">((</span><span class="pp">inherits</span><span class="op">)</span><span class="pp"> </span><span class="op">?</span><span class="pp"> findVar</span><span class="op">((</span><span class="pp">sym</span><span class="op">),</span><span class="pp"> </span><span class="op">(</span><span class="pp">rho</span><span class="op">))</span><span class="pp"> </span><span class="op">:</span><span class="pp"> findVarInFrame</span><span class="op">((</span><span class="pp">rho</span><span class="op">),</span><span class="pp"> </span><span class="op">(</span><span class="pp">sym</span><span class="op">)))</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>SEXP SD <span class="op">=</span> PROTECT<span class="op">(</span>R_getVar<span class="op">(</span>install<span class="op">(</span><span class="st">".SD"</span><span class="op">),</span> env<span class="op">,</span> TRUE<span class="op">));</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>               <span class="co">// ^^^^^^^^ introduced in R-4.5</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Status</strong> in <code>data.table</code>: not fixed yet. Will need to wait for R-4.5.0 to be released with the new interface.</p>
</section>
<section id="getoption" class="level2">
<h2 class="anchored" data-anchor-id="getoption"><code>GetOption</code></h2>
<p>Used in <code>src/rbindlist.c</code> to read the <a href="https://github.com/Rdatatable/data.table/blob/master/src/rbindlist.c#L231"><code>datatable.rbindlist.check</code></a> option, <code>src/freadR.c</code> to read the <a href="https://github.com/Rdatatable/data.table/blob/master/src/freadR.c#L132"><code>datatable.old.fread.datetime.character</code></a> option, <code>src/init.c</code> to read the <a href="https://github.com/Rdatatable/data.table/blob/master/src/init.c#L331"><code>datatable.verbose</code></a> option, <code>src/forder.c</code> to get the <a href="https://github.com/Rdatatable/data.table/blob/master/src/forder.c#L1619-L1637"><code>datatable.use.index</code> and <code>datatable.forder.auto.index</code></a> options, and <code>src/subset.c</code> to read the <a href="https://github.com/Rdatatable/data.table/blob/master/src/subset.c#L299"><code>datatable.alloccol</code></a> option.</p>
<blockquote class="blockquote">
<p>Use <code>GetOption1</code>.</p>
</blockquote>
<p>– <a href="https://cran.r-project.org/doc/manuals/r-devel/R-exts.html#Some-API-replacements-for-non_002dAPI-entry-points">WRE 6.21.1</a></p>
<p>The difference is that <code>GetOption1</code> doesn’t take a second argument <code>rho</code>, which <code>GetOption</code> has been ignoring anyway.</p>
<p>Example of the problem:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>SEXP opt <span class="op">=</span> GetOption<span class="op">(</span>install<span class="op">(</span><span class="st">"datatable.use.index"</span><span class="op">),</span> R_NilValue<span class="op">);</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ^^^^^^^^^ non-API function</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Solution:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>SEXP opt <span class="op">=</span> GetOption1<span class="op">(</span>install<span class="op">(</span><span class="st">"datatable.use.index"</span><span class="op">));</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ^^^^^^^^^^ API function introduced in R-2.13</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Status</strong> in <code>data.table</code>: not fixed yet.</p>
</section>
<section id="testing-for-a-data.frame-isframe" class="level2">
<h2 class="anchored" data-anchor-id="testing-for-a-data.frame-isframe">Testing for a <code>data.frame</code>: <code>isFrame</code></h2>
<p>Back in 2012, Matt Dowle needed to quickly test an object for being a <code>data.frame</code>, and the undocumented function <code>isFrame</code> seemed like it <a href="https://github.com/Rdatatable/data.table/commit/87666e70ce1a69b28f0e92ec7504d80e3d53a824#diff-4fc47a9752ba4edfef0cabcc1958eda943545ad3859e48d498b0e3f87a9ae5aeR192">did the job</a>. Since <code>isFrame</code> was not part of the documented interface, in 2024 Luke Tierney gave the function a better-fitting name, <a href="https://github.com/r-devel/r-svn/commit/4ef83b9dc3c6874e774195d329cbb6c11a71c414"><code>isDataFrame</code></a>, and made it an experimental entry point, while retaining the original function as a wrapper.</p>
<p>Use of <code>isFrame</code> <a href="https://github.com/Rdatatable/data.table/issues/6244">doesn’t give a <code>NOTE</code> yet</a>, but when R-4.5.0 is released together with the new name for the function, <code>data.table</code> will be able to use it, falling back to <code>isFrame</code> on older versions of R. <code>isDataFrame</code> is documented among other <a href="https://cran.r-project.org/doc/manuals/r-devel/R-exts.html#Some-API-replacements-for-non_002dAPI-entry-points">replacement entry point names</a> in Writing R Extensions.</p>
<p>Problem (the only instance in <code>data.table</code>):</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(!</span>isVector<span class="op">(</span>thiscol<span class="op">)</span> <span class="op">||</span> isFrame<span class="op">(</span>thiscol<span class="op">))</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>                       <span class="co">// ^^^^^^^ may disappear in a future R version</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Solution:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#if R_VERSION &lt; R_Version(4, 5, 0)</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="co">// R versions older than 4.5.0 released use the old name of the function</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#define isDataFrame</span><span class="op">(</span><span class="pp">x</span><span class="op">)</span><span class="pp"> </span><span class="op">(</span><span class="pp">isFrame</span><span class="op">(</span><span class="pp">x</span><span class="op">))</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="co">// later:</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(!</span>isVector<span class="op">(</span>thiscol<span class="op">)</span> <span class="op">||</span> isDataFrame<span class="op">(</span>thiscol<span class="op">))</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>                       <span class="co">// ^^^^^^^^^^^ introduced in R-4.5</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Status</strong> in <code>data.table</code>: change reverted in <a href="https://github.com/Rdatatable/data.table/issues/6244">#6244</a>, waiting for R-4.5.0 to release with the new interface.</p>
</section>
<section id="object" class="level2">
<h2 class="anchored" data-anchor-id="object"><code>OBJECT</code></h2>
<p>Used in <code>src/assign.c</code> to <a href="https://github.com/Rdatatable/data.table/blob/03c647f9a44710aad834c0718e0b34e8c5341bf1/src/assign.c#L1158">test whether S3 dispatch is possible on an object</a> before spending CPU time on constructing and evaluating an R-level call to <code>as.character</code> instead of <code>coerceVector</code>.</p>
<blockquote class="blockquote">
<p>Use <code>isObject</code>.</p>
</blockquote>
<p>– <a href="https://cran.r-project.org/doc/manuals/r-devel/R-exts.html#Some-API-replacements-for-non_002dAPI-entry-points">WRE 6.21.1</a></p>
<p>Problem:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>OBJECT<span class="op">(</span>source<span class="op">)</span> <span class="op">&amp;&amp;</span> getAttrib<span class="op">(</span>source<span class="op">,</span> R_ClassSymbol<span class="op">)!=</span>R_NilValue<span class="op">)</span> <span class="op">{</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a> <span class="co">// ^^^^^^ non-API entry point</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Solution:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>isObject<span class="op">(</span>source<span class="op">))</span> <span class="op">{</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a> <span class="co">// ^^^^^^^^ API entry point</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Most likely, the check for <code>getAttrib(source, R_ClassSymbol)</code> is superfluous, because when used correctly, R API maintains the object bit set only when the <code>class</code> attribute is non-empty.</p>
<p><strong>Status</strong> in <code>data.table</code>: not fixed yet.</p>
</section>
</section>
<section id="conclusion" class="level1">
<h1>Conclusion</h1>
<p>While <code>data.table</code> could get rid of most of its non-API use with relative ease, either using a different name for the function (<code>STRING_PTR_RO</code>, <code>GetOption1</code>) or adding a wrapper for R &lt; 4.5 (<code>ANY_ATTRIB</code>, <code>findVar</code>), two interfaces will require a significant amount of work.</p>
<p>Replacing the use of <code>TRUELENGTH</code> and related functions will require implementing two features from scratch: a set of ALTREP classes for growable vectors (with the previous implementation hidden in <code>#ifdef</code> for R &lt; 4.3) and pointer-keyed hash tables for string and column marking.</p>
<p>It is not currently clear how to replace the use of <code>ATTRIB</code>.</p>




</section>

<div class="quarto-listing quarto-listing-container-default" id="listing-listing">
<div class="list quarto-listing-default">
<div class="quarto-post image-right" data-index="0" data-categories="dHV0b3JpYWxzJTJDY29tbXVuaXR5" data-listing-date-sort="1733529600000" data-listing-file-modified-sort="1752181549044" data-listing-date-modified-sort="NaN" data-listing-reading-time-sort="2" data-listing-word-count-sort="326">
<div class="thumbnail"><a href="../../posts/2024-12-07-advent_of_code-kelly_bodwin/index.html" class="no-external">

<img loading="lazy" src="../../posts/2024-12-07-advent_of_code-kelly_bodwin/aoc2.png" class="thumbnail-image">

</a></div>
<div class="body">
<h3 class="no-anchor listing-title">
<a href="../../posts/2024-12-07-advent_of_code-kelly_bodwin/index.html" class="no-external">Advent of Code with <code>data.table</code>: Week One</a>
</h3>
<div class="listing-subtitle">
<a href="../../posts/2024-12-07-advent_of_code-kelly_bodwin/index.html" class="no-external"></a>
</div>
<div class="listing-categories">

<div class="listing-category" onclick="window.quartoListingCategory('dHV0b3JpYWxz'); return false;">tutorials</div>

<div class="listing-category" onclick="window.quartoListingCategory('Y29tbXVuaXR5'); return false;">community</div>

</div>
<div class="delink listing-description"><a href="../../posts/2024-12-07-advent_of_code-kelly_bodwin/index.html" class="no-external">
Happy December, R friends!
</a></div>
</div>
<div class="metadata">
<a href="../../posts/2024-12-07-advent_of_code-kelly_bodwin/index.html" class="no-external">
<div class="listing-date">
Dec 7, 2024
</div>
<div class="listing-author">
Kelly Bodwin
</div>
</a>
</div>
</div>
<div class="quarto-post image-right" data-index="1" data-categories="dGlwcyUyQ3R1dG9yaWFscyUyQ2RldmVsb3BlciUyQ2JlbmNobWFya3M=" data-listing-date-sort="1729123200000" data-listing-file-modified-sort="1752181549026" data-listing-date-modified-sort="NaN" data-listing-reading-time-sort="21" data-listing-word-count-sort="4191">
<div class="thumbnail"><a href="../../posts/2024-10-17-duckdb_polars_reshape-toby_hocking/index.html" class="no-external">

<img loading="lazy" src="../../posts/2024-10-17-duckdb_polars_reshape-toby_hocking/duckdb.png" class="thumbnail-image">

</a></div>
<div class="body">
<h3 class="no-anchor listing-title">
<a href="../../posts/2024-10-17-duckdb_polars_reshape-toby_hocking/index.html" class="no-external">Comparing <code>data.table</code> reshape to <code>duckdb</code> and <code>polars</code></a>
</h3>
<div class="listing-subtitle">
<a href="../../posts/2024-10-17-duckdb_polars_reshape-toby_hocking/index.html" class="no-external"></a>
</div>
<div class="listing-categories">

<div class="listing-category" onclick="window.quartoListingCategory('dGlwcw=='); return false;">tips</div>

<div class="listing-category" onclick="window.quartoListingCategory('dHV0b3JpYWxz'); return false;">tutorials</div>

<div class="listing-category" onclick="window.quartoListingCategory('ZGV2ZWxvcGVy'); return false;">developer</div>

<div class="listing-category" onclick="window.quartoListingCategory('YmVuY2htYXJrcw=='); return false;">benchmarks</div>

</div>
<div class="delink listing-description"><a href="../../posts/2024-10-17-duckdb_polars_reshape-toby_hocking/index.html" class="no-external">
One element of the NSF POSE grant for <code>data.table</code> is to create benchmarks which can inform users about when <code>data.table</code> could be more performant than similar software. Two…<code></code><code></code>
</a></div>
</div>
<div class="metadata">
<a href="../../posts/2024-10-17-duckdb_polars_reshape-toby_hocking/index.html" class="no-external">
<div class="listing-date">
Oct 17, 2024
</div>
<div class="listing-author">
Toby Dylan Hocking
</div>
</a>
</div>
</div>
<div class="quarto-post image-right" data-index="2" data-categories="cGVyZm9ybWFuY2UlMkN0ZXN0aW5nJTJDZGV2ZWxvcGVy" data-listing-date-sort="1728518400000" data-listing-file-modified-sort="1752181549025" data-listing-date-modified-sort="NaN" data-listing-reading-time-sort="12" data-listing-word-count-sort="2217">
<div class="thumbnail"><a href="../../posts/2024-10-10-Performance-Doris_Amoakohene/index.html" class="no-external">

<img loading="lazy" src="../../posts/2024-10-10-Performance-Doris_Amoakohene/atime.png" class="thumbnail-image">

</a></div>
<div class="body">
<h3 class="no-anchor listing-title">
<a href="../../posts/2024-10-10-Performance-Doris_Amoakohene/index.html" class="no-external">Visualizing performance regression of <code>data.table</code> with <code>atime</code></a>
</h3>
<div class="listing-subtitle">
<a href="../../posts/2024-10-10-Performance-Doris_Amoakohene/index.html" class="no-external"></a>
</div>
<div class="listing-categories">

<div class="listing-category" onclick="window.quartoListingCategory('cGVyZm9ybWFuY2U='); return false;">performance</div>

<div class="listing-category" onclick="window.quartoListingCategory('dGVzdGluZw=='); return false;">testing</div>

<div class="listing-category" onclick="window.quartoListingCategory('ZGV2ZWxvcGVy'); return false;">developer</div>

</div>
<div class="delink listing-description"><a href="../../posts/2024-10-10-Performance-Doris_Amoakohene/index.html" class="no-external">
Since August 2023, I have been working on performance testing, which could be useful for expanding the open-source ecosystem around <code>data.table</code> package in R. This could…<code></code>
</a></div>
</div>
<div class="metadata">
<a href="../../posts/2024-10-10-Performance-Doris_Amoakohene/index.html" class="no-external">
<div class="listing-date">
Oct 10, 2024
</div>
<div class="listing-author">
Doris Afriyie Amoakohene
</div>
</a>
</div>
</div>
<div class="quarto-post image-right" data-index="3" data-categories="c2VhbCUyMG9mJTIwYXBwcm92YWwlMkNhcHBsaWNhdGlvbiUyMHBhY2thZ2U=" data-listing-date-sort="1727740800000" data-listing-file-modified-sort="1752181549001" data-listing-date-modified-sort="NaN" data-listing-reading-time-sort="2" data-listing-word-count-sort="381">
<div class="thumbnail"><a href="../../posts/2024-10-01-seal_of_approval-mlr3/index.html" class="no-external">

<img loading="lazy" src="../../posts/2024-10-01-seal_of_approval-mlr3/hex_approved.png" class="thumbnail-image">

</a></div>
<div class="body">
<h3 class="no-anchor listing-title">
<a href="../../posts/2024-10-01-seal_of_approval-mlr3/index.html" class="no-external">Seal of Approval: mlr3</a>
</h3>
<div class="listing-subtitle">
<a href="../../posts/2024-10-01-seal_of_approval-mlr3/index.html" class="no-external"></a>
</div>
<div class="listing-categories">

<div class="listing-category" onclick="window.quartoListingCategory('c2VhbCUyMG9mJTIwYXBwcm92YWw='); return false;">seal of approval</div>

<div class="listing-category" onclick="window.quartoListingCategory('YXBwbGljYXRpb24lMjBwYWNrYWdl'); return false;">application package</div>

</div>
<div class="delink listing-description"><a href="../../posts/2024-10-01-seal_of_approval-mlr3/index.html" class="no-external">
<em>Author(s):</em> Michel Lang, Bernd Bischl, Jakob Richter, Patrick Schratz, Martin Binder, Florian Pfisterer, Raphael Sonabend, Marc Becker, Sebastian Fischer
</a></div>
</div>
<div class="metadata">
<a href="../../posts/2024-10-01-seal_of_approval-mlr3/index.html" class="no-external">
<div class="listing-date">
Oct 1, 2024
</div>
<div class="listing-author">
Maximilian Mücke
</div>
</a>
</div>
</div>
<div class="quarto-post image-right" data-index="4" data-categories="c2VhbCUyMG9mJTIwYXBwcm92YWwlMkNwYXJ0bmVyJTIwcGFja2FnZQ==" data-listing-date-sort="1726876800000" data-listing-file-modified-sort="1752181549001" data-listing-date-modified-sort="NaN" data-listing-reading-time-sort="5" data-listing-word-count-sort="981">
<div class="thumbnail"><a href="../../posts/2024-09-21-seal_of_approval-collapse/index.html" class="no-external">

<img loading="lazy" src="../../posts/2024-09-21-seal_of_approval-collapse/hex_approved.png" class="thumbnail-image">

</a></div>
<div class="body">
<h3 class="no-anchor listing-title">
<a href="../../posts/2024-09-21-seal_of_approval-collapse/index.html" class="no-external">Seal of Approval: collapse</a>
</h3>
<div class="listing-subtitle">
<a href="../../posts/2024-09-21-seal_of_approval-collapse/index.html" class="no-external"></a>
</div>
<div class="listing-categories">

<div class="listing-category" onclick="window.quartoListingCategory('c2VhbCUyMG9mJTIwYXBwcm92YWw='); return false;">seal of approval</div>

<div class="listing-category" onclick="window.quartoListingCategory('cGFydG5lciUyMHBhY2thZ2U='); return false;">partner package</div>

</div>
<div class="delink listing-description"><a href="../../posts/2024-09-21-seal_of_approval-collapse/index.html" class="no-external">
<em>Author(s):</em> Sebastian Krantz
</a></div>
</div>
<div class="metadata">
<a href="../../posts/2024-09-21-seal_of_approval-collapse/index.html" class="no-external">
<div class="listing-date">
Sep 21, 2024
</div>
<div class="listing-author">
Sebastian Krantz
</div>
</a>
</div>
</div>
<div class="quarto-post image-right" data-index="5" data-categories="YW5ub3VuY2VtZW50cyUyQ2dyYW50JTJDdHJhbnNsYXRpb24=" data-listing-date-sort="1724112000000" data-listing-file-modified-sort="1752181548999" data-listing-date-modified-sort="NaN" data-listing-reading-time-sort="1" data-listing-word-count-sort="140">
<div class="thumbnail"><a href="../../posts/2024-08-20-translation_projects-community_team/index.html" class="no-external">

<img loading="lazy" src="../../posts/2024-08-20-translation_projects-community_team/languages.jpeg" class="thumbnail-image">

</a></div>
<div class="body">
<h3 class="no-anchor listing-title">
<a href="../../posts/2024-08-20-translation_projects-community_team/index.html" class="no-external">Newly awarded translation projects</a>
</h3>
<div class="listing-subtitle">
<a href="../../posts/2024-08-20-translation_projects-community_team/index.html" class="no-external"></a>
</div>
<div class="listing-categories">

<div class="listing-category" onclick="window.quartoListingCategory('YW5ub3VuY2VtZW50cw=='); return false;">announcements</div>

<div class="listing-category" onclick="window.quartoListingCategory('Z3JhbnQ='); return false;">grant</div>

<div class="listing-category" onclick="window.quartoListingCategory('dHJhbnNsYXRpb24='); return false;">translation</div>

</div>
<div class="delink listing-description"><a href="../../posts/2024-08-20-translation_projects-community_team/index.html" class="no-external">
We are pleased to fund a French translation project, led by Philippe Grosjean, who is also the leader of the base R French translation. Co-authors include Christian Wia…
</a></div>
</div>
<div class="metadata">
<a href="../../posts/2024-08-20-translation_projects-community_team/index.html" class="no-external">
<div class="listing-date">
Aug 20, 2024
</div>
<div class="listing-author">
Toby Dylan Hocking
</div>
</a>
</div>
</div>
<div class="quarto-post image-right" data-index="6" data-categories="c2VhbCUyMG9mJTIwYXBwcm92YWwlMkNicmlkZ2UlMjBwYWNrYWdl" data-listing-date-sort="1722470400000" data-listing-file-modified-sort="1752181548986" data-listing-date-modified-sort="NaN" data-listing-reading-time-sort="2" data-listing-word-count-sort="253">
<div class="thumbnail"><a href="../../posts/2024-08-01-seal_of_approval-dtplyr/index.html" class="no-external">

<img loading="lazy" src="../../posts/2024-08-01-seal_of_approval-dtplyr/hex_approved.png" class="thumbnail-image">

</a></div>
<div class="body">
<h3 class="no-anchor listing-title">
<a href="../../posts/2024-08-01-seal_of_approval-dtplyr/index.html" class="no-external">Seal of Approval: dtplyr</a>
</h3>
<div class="listing-subtitle">
<a href="../../posts/2024-08-01-seal_of_approval-dtplyr/index.html" class="no-external"></a>
</div>
<div class="listing-categories">

<div class="listing-category" onclick="window.quartoListingCategory('c2VhbCUyMG9mJTIwYXBwcm92YWw='); return false;">seal of approval</div>

<div class="listing-category" onclick="window.quartoListingCategory('YnJpZGdlJTIwcGFja2FnZQ=='); return false;">bridge package</div>

</div>
<div class="delink listing-description"><a href="../../posts/2024-08-01-seal_of_approval-dtplyr/index.html" class="no-external">
<em>Author(s):</em> Hadley Wickham, Maximilian Girlich, Mark Fairbanks, Ryan Dickerson, Posit Software PBC
</a></div>
</div>
<div class="metadata">
<a href="../../posts/2024-08-01-seal_of_approval-dtplyr/index.html" class="no-external">
<div class="listing-date">
Aug 1, 2024
</div>
<div class="listing-author">
Kelly Bodwin
</div>
</a>
</div>
</div>
<div class="quarto-post image-right" data-index="7" data-categories="c2VhbCUyMG9mJTIwYXBwcm92YWwlMkNleHRlbnNpb24lMjBwYWNrYWdl" data-listing-date-sort="1722470400000" data-listing-file-modified-sort="1752181548989" data-listing-date-modified-sort="NaN" data-listing-reading-time-sort="4" data-listing-word-count-sort="698">
<div class="thumbnail"><a href="../../posts/2024-08-01-seal_of_approval-nc/index.html" class="no-external">

<img loading="lazy" src="../../posts/2024-08-01-seal_of_approval-nc/hex_approved.png" class="thumbnail-image">

</a></div>
<div class="body">
<h3 class="no-anchor listing-title">
<a href="../../posts/2024-08-01-seal_of_approval-nc/index.html" class="no-external">Seal of Approval: nc</a>
</h3>
<div class="listing-subtitle">
<a href="../../posts/2024-08-01-seal_of_approval-nc/index.html" class="no-external"></a>
</div>
<div class="listing-categories">

<div class="listing-category" onclick="window.quartoListingCategory('c2VhbCUyMG9mJTIwYXBwcm92YWw='); return false;">seal of approval</div>

<div class="listing-category" onclick="window.quartoListingCategory('ZXh0ZW5zaW9uJTIwcGFja2FnZQ=='); return false;">extension package</div>

</div>
<div class="delink listing-description"><a href="../../posts/2024-08-01-seal_of_approval-nc/index.html" class="no-external">
<em>Maintainer:</em> Toby Dylan Hocking (toby.hocking@r-project.org)
</a></div>
</div>
<div class="metadata">
<a href="../../posts/2024-08-01-seal_of_approval-nc/index.html" class="no-external">
<div class="listing-date">
Aug 1, 2024
</div>
<div class="listing-author">
Toby Dylan Hocking
</div>
</a>
</div>
</div>
<div class="quarto-post image-right" data-index="8" data-categories="c2VhbCUyMG9mJTIwYXBwcm92YWwlMkNicmlkZ2UlMjBwYWNrYWdl" data-listing-date-sort="1722470400000" data-listing-file-modified-sort="1752181548999" data-listing-date-modified-sort="NaN" data-listing-reading-time-sort="4" data-listing-word-count-sort="657">
<div class="thumbnail"><a href="../../posts/2024-08-01-seal_of_approval-tidyfast/index.html" class="no-external">

<img loading="lazy" src="../../posts/2024-08-01-seal_of_approval-tidyfast/hex_approved.png" class="thumbnail-image">

</a></div>
<div class="body">
<h3 class="no-anchor listing-title">
<a href="../../posts/2024-08-01-seal_of_approval-tidyfast/index.html" class="no-external">Seal of Approval: tidyfast</a>
</h3>
<div class="listing-subtitle">
<a href="../../posts/2024-08-01-seal_of_approval-tidyfast/index.html" class="no-external"></a>
</div>
<div class="listing-categories">

<div class="listing-category" onclick="window.quartoListingCategory('c2VhbCUyMG9mJTIwYXBwcm92YWw='); return false;">seal of approval</div>

<div class="listing-category" onclick="window.quartoListingCategory('YnJpZGdlJTIwcGFja2FnZQ=='); return false;">bridge package</div>

</div>
<div class="delink listing-description"><a href="../../posts/2024-08-01-seal_of_approval-tidyfast/index.html" class="no-external">
<em>Author(s):</em> Tyson S. Barrett, Mark Fairbanks, Ivan Leung, Indrajeet Patil
</a></div>
</div>
<div class="metadata">
<a href="../../posts/2024-08-01-seal_of_approval-tidyfast/index.html" class="no-external">
<div class="listing-date">
Aug 1, 2024
</div>
<div class="listing-author">
Tyson S. Barrett
</div>
</a>
</div>
</div>
<div class="quarto-post image-right" data-index="9" data-categories="YW5ub3VuY2VtZW50cyUyQ2dyYW50JTJDY29tbXVuaXR5JTJDc2VhbCUyMG9mJTIwYXBwcm92YWw=" data-listing-date-sort="1722384000000" data-listing-file-modified-sort="1752181548974" data-listing-date-modified-sort="NaN" data-listing-reading-time-sort="2" data-listing-word-count-sort="215">
<div class="thumbnail"><a href="../../posts/2024-07-31-seal_of_approval_announcement-community_team/index.html" class="no-external">

<img loading="lazy" src="../../posts/2024-07-31-seal_of_approval_announcement-community_team/seal_of_approval.png" class="thumbnail-image">

</a></div>
<div class="body">
<h3 class="no-anchor listing-title">
<a href="../../posts/2024-07-31-seal_of_approval_announcement-community_team/index.html" class="no-external">Announcement: The ‘Seal of Approval’</a>
</h3>
<div class="listing-subtitle">
<a href="../../posts/2024-07-31-seal_of_approval_announcement-community_team/index.html" class="no-external"></a>
</div>
<div class="listing-categories">

<div class="listing-category" onclick="window.quartoListingCategory('YW5ub3VuY2VtZW50cw=='); return false;">announcements</div>

<div class="listing-category" onclick="window.quartoListingCategory('Z3JhbnQ='); return false;">grant</div>

<div class="listing-category" onclick="window.quartoListingCategory('Y29tbXVuaXR5'); return false;">community</div>

<div class="listing-category" onclick="window.quartoListingCategory('c2VhbCUyMG9mJTIwYXBwcm92YWw='); return false;">seal of approval</div>

</div>
<div class="delink listing-description"><a href="../../posts/2024-07-31-seal_of_approval_announcement-community_team/index.html" class="no-external">
The Community Team, alongside a group of regular <code>data.table</code> contributors, is very pleased to announce a new <strong>Seal of Approval</strong> program!
</a></div>
</div>
<div class="metadata">
<a href="../../posts/2024-07-31-seal_of_approval_announcement-community_team/index.html" class="no-external">
<div class="listing-date">
Jul 31, 2024
</div>
<div class="listing-author">
Kelly Bodwin
</div>
</a>
</div>
</div>
<div class="quarto-post image-right" data-index="10" data-categories="YW5ub3VuY2VtZW50cyUyQ2dyYW50JTJDYW1iYXNzYWRvcnMlMkN0cmF2ZWw=" data-listing-date-sort="1718150400000" data-listing-file-modified-sort="1752181548974" data-listing-date-modified-sort="NaN" data-listing-reading-time-sort="2" data-listing-word-count-sort="311">
<div class="thumbnail"><a href="../../posts/2024-06-09-ambassador_corrales-community_team/index.html" class="no-external">

<img loading="lazy" src="../../posts/2024-06-09-ambassador_corrales-community_team/Paola_Corrales.jpg" class="thumbnail-image">

</a></div>
<div class="body">
<h3 class="no-anchor listing-title">
<a href="../../posts/2024-06-09-ambassador_corrales-community_team/index.html" class="no-external">Announcement: Paola Corrales, data.table Ambassador</a>
</h3>
<div class="listing-subtitle">
<a href="../../posts/2024-06-09-ambassador_corrales-community_team/index.html" class="no-external"></a>
</div>
<div class="listing-categories">

<div class="listing-category" onclick="window.quartoListingCategory('YW5ub3VuY2VtZW50cw=='); return false;">announcements</div>

<div class="listing-category" onclick="window.quartoListingCategory('Z3JhbnQ='); return false;">grant</div>

<div class="listing-category" onclick="window.quartoListingCategory('YW1iYXNzYWRvcnM='); return false;">ambassadors</div>

<div class="listing-category" onclick="window.quartoListingCategory('dHJhdmVs'); return false;">travel</div>

</div>
<div class="delink listing-description"><a href="../../posts/2024-06-09-ambassador_corrales-community_team/index.html" class="no-external">
Paola is a professor teaching Data Science at Guillermo Brown University in Argentina, a developer of R packages and teaching materials, and a leader of the LatinR…<code></code><code></code><code></code>
</a></div>
</div>
<div class="metadata">
<a href="../../posts/2024-06-09-ambassador_corrales-community_team/index.html" class="no-external">
<div class="listing-date">
Jun 12, 2024
</div>
<div class="listing-author">
Community Team
</div>
</a>
</div>
</div>
<div class="quarto-post image-right" data-index="11" data-categories="b3Bpbmlvbg==" data-listing-date-sort="1717459200000" data-listing-file-modified-sort="1752181548962" data-listing-date-modified-sort="NaN" data-listing-reading-time-sort="8" data-listing-word-count-sort="1405">
<div class="thumbnail"><a href="../../posts/2024-05-20-kelly_bodwin/index.html" class="no-external">

<img loading="lazy" src="../../posts/2024-05-20-kelly_bodwin/paths.jpg" class="thumbnail-image">

</a></div>
<div class="body">
<h3 class="no-anchor listing-title">
<a href="../../posts/2024-05-20-kelly_bodwin/index.html" class="no-external">Two Roads Diverged</a>
</h3>
<div class="listing-subtitle">
<a href="../../posts/2024-05-20-kelly_bodwin/index.html" class="no-external"></a>
</div>
<div class="listing-categories">

<div class="listing-category" onclick="window.quartoListingCategory('b3Bpbmlvbg=='); return false;">opinion</div>

</div>
<div class="delink listing-description"><a href="../../posts/2024-05-20-kelly_bodwin/index.html" class="no-external">
Two roads diverged in a wood and I, I took the one less traveled by, and that has made all the difference.
</a></div>
</div>
<div class="metadata">
<a href="../../posts/2024-05-20-kelly_bodwin/index.html" class="no-external">
<div class="listing-date">
Jun 4, 2024
</div>
<div class="listing-author">
Kelly Bodwin
</div>
</a>
</div>
</div>
<div class="quarto-post image-right" data-index="12" data-categories="Z3JhbnQlMkN0ZXN0aW5nJTJDZGV2ZWxvcGVy" data-listing-date-sort="1710028800000" data-listing-file-modified-sort="1752181548962" data-listing-date-modified-sort="NaN" data-listing-reading-time-sort="8" data-listing-word-count-sort="1527">
<div class="thumbnail"><a href="../../posts/2024-03-10-testing_plan-toby_hocking/index.html" class="no-external">

<img loading="lazy" src="../../posts/2024-03-10-testing_plan-toby_hocking/code_testing.png" class="thumbnail-image">

</a></div>
<div class="body">
<h3 class="no-anchor listing-title">
<a href="../../posts/2024-03-10-testing_plan-toby_hocking/index.html" class="no-external">Testing infrastructure for data.table</a>
</h3>
<div class="listing-subtitle">
<a href="../../posts/2024-03-10-testing_plan-toby_hocking/index.html" class="no-external"></a>
</div>
<div class="listing-categories">

<div class="listing-category" onclick="window.quartoListingCategory('Z3JhbnQ='); return false;">grant</div>

<div class="listing-category" onclick="window.quartoListingCategory('dGVzdGluZw=='); return false;">testing</div>

<div class="listing-category" onclick="window.quartoListingCategory('ZGV2ZWxvcGVy'); return false;">developer</div>

</div>
<div class="delink listing-description"><a href="../../posts/2024-03-10-testing_plan-toby_hocking/index.html" class="no-external">
One major element of the NSF POSE grant for <code>data.table</code> is to create more documentation and testing infrastructure, in order to help expand the <code>data.table</code> ecosystem. This…
</a></div>
</div>
<div class="metadata">
<a href="../../posts/2024-03-10-testing_plan-toby_hocking/index.html" class="no-external">
<div class="listing-date">
Mar 10, 2024
</div>
<div class="listing-author">
Toby Hocking
</div>
</a>
</div>
</div>
<div class="quarto-post image-right" data-index="13" data-categories="Y29tbXVuaXR5JTJDZ3JhbnQ=" data-listing-date-sort="1709683200000" data-listing-file-modified-sort="1752181548961" data-listing-date-modified-sort="NaN" data-listing-reading-time-sort="17" data-listing-word-count-sort="3396">
<div class="thumbnail"><a href="../../posts/2024-03-06-interviews-anirban_chetia/index.html" class="no-external">

<img loading="lazy" src="../../posts/2024-03-06-interviews-anirban_chetia/index.jpeg" class="thumbnail-image">

</a></div>
<div class="body">
<h3 class="no-anchor listing-title">
<a href="../../posts/2024-03-06-interviews-anirban_chetia/index.html" class="no-external">Community interviews about data.table</a>
</h3>
<div class="listing-subtitle">
<a href="../../posts/2024-03-06-interviews-anirban_chetia/index.html" class="no-external"></a>
</div>
<div class="listing-categories">

<div class="listing-category" onclick="window.quartoListingCategory('Y29tbXVuaXR5'); return false;">community</div>

<div class="listing-category" onclick="window.quartoListingCategory('Z3JhbnQ='); return false;">grant</div>

</div>
<div class="delink listing-description"><a href="../../posts/2024-03-06-interviews-anirban_chetia/index.html" class="no-external">
One stipulation of NSF POSE funded projects like this one was to conduct several interviews under NSF’s I-CORPS program (Winter 2024 Cohort), to gather information as to how <code>…</code><strong></strong><code></code>
</a></div>
</div>
<div class="metadata">
<a href="../../posts/2024-03-06-interviews-anirban_chetia/index.html" class="no-external">
<div class="listing-date">
Mar 6, 2024
</div>
<div class="listing-author">
Anirban Chetia
</div>
</a>
</div>
</div>
<div class="quarto-post image-right" data-index="14" data-categories="Y29tbXVuaXR5JTJDZ3Vlc3QlMjBwb3N0JTJDZ292ZXJuYW5jZQ==" data-listing-date-sort="1708819200000" data-listing-file-modified-sort="1752181548954" data-listing-date-modified-sort="NaN" data-listing-reading-time-sort="6" data-listing-word-count-sort="1190">
<div class="thumbnail"><a href="../../posts/2024-02-25-survey_2023-aljaz_sluga/index.html" class="no-external">

<img loading="lazy" src="../../posts/2024-02-25-survey_2023-aljaz_sluga/usage_frequency.png" class="thumbnail-image">

</a></div>
<div class="body">
<h3 class="no-anchor listing-title">
<a href="../../posts/2024-02-25-survey_2023-aljaz_sluga/index.html" class="no-external">Results of the 2023 survey</a>
</h3>
<div class="listing-subtitle">
<a href="../../posts/2024-02-25-survey_2023-aljaz_sluga/index.html" class="no-external"></a>
</div>
<div class="listing-categories">

<div class="listing-category" onclick="window.quartoListingCategory('Y29tbXVuaXR5'); return false;">community</div>

<div class="listing-category" onclick="window.quartoListingCategory('Z3Vlc3QlMjBwb3N0'); return false;">guest post</div>

<div class="listing-category" onclick="window.quartoListingCategory('Z292ZXJuYW5jZQ=='); return false;">governance</div>

</div>
<div class="delink listing-description"><a href="../../posts/2024-02-25-survey_2023-aljaz_sluga/index.html" class="no-external">
Thanks to everyone who helped create, shared, or filled out the first data.table survey! The survey was officially open between October 17 and December 1 and it received <strong>391</strong> …
</a></div>
</div>
<div class="metadata">
<a href="../../posts/2024-02-25-survey_2023-aljaz_sluga/index.html" class="no-external">
<div class="listing-date">
Feb 25, 2024
</div>
<div class="listing-author">
Aljaž Sluga
</div>
</a>
</div>
</div>
<div class="quarto-post image-right" data-index="15" data-categories="dGlwcyUyQ3R1dG9yaWFscyUyQ2RldmVsb3Blcg==" data-listing-date-sort="1708214400000" data-listing-file-modified-sort="1752181548952" data-listing-date-modified-sort="NaN" data-listing-reading-time-sort="5" data-listing-word-count-sort="918">
<div class="thumbnail"><a href="../../posts/2024-02-18-dt_particularities-toby_hocking/index.html" class="no-external">

<img loading="lazy" src="../../posts/2024-02-18-dt_particularities-toby_hocking/copy_on_modify.png" class="thumbnail-image">

</a></div>
<div class="body">
<h3 class="no-anchor listing-title">
<a href="../../posts/2024-02-18-dt_particularities-toby_hocking/index.html" class="no-external">Column assignment and reference semantics in data.table</a>
</h3>
<div class="listing-subtitle">
<a href="../../posts/2024-02-18-dt_particularities-toby_hocking/index.html" class="no-external"></a>
</div>
<div class="listing-categories">

<div class="listing-category" onclick="window.quartoListingCategory('dGlwcw=='); return false;">tips</div>

<div class="listing-category" onclick="window.quartoListingCategory('dHV0b3JpYWxz'); return false;">tutorials</div>

<div class="listing-category" onclick="window.quartoListingCategory('ZGV2ZWxvcGVy'); return false;">developer</div>

</div>
<div class="delink listing-description"><a href="../../posts/2024-02-18-dt_particularities-toby_hocking/index.html" class="no-external">
The goal of this blog post is to explain some similarities and differences between the base R <code>data.frame</code> object type, and the <code>data.table</code> object type. We will focus on…
</a></div>
</div>
<div class="metadata">
<a href="../../posts/2024-02-18-dt_particularities-toby_hocking/index.html" class="no-external">
<div class="listing-date">
Feb 18, 2024
</div>
<div class="listing-author">
Toby Hocking
</div>
</a>
</div>
</div>
<div class="quarto-post image-right" data-index="16" data-categories="dGlwcyUyQ3R1dG9yaWFscyUyQ2RvY3VtZW50YXRpb24=" data-listing-date-sort="1707091200000" data-listing-file-modified-sort="1752181548952" data-listing-date-modified-sort="NaN" data-listing-reading-time-sort="5" data-listing-word-count-sort="914">
<div class="thumbnail"><a href="../../posts/2024-02-05-tips_tricks_1-tyson_barrett/index.html" class="no-external">

<img loading="lazy" src="../../posts/2024-02-05-tips_tricks_1-tyson_barrett/brackets.png" class="thumbnail-image">

</a></div>
<div class="body">
<h3 class="no-anchor listing-title">
<a href="../../posts/2024-02-05-tips_tricks_1-tyson_barrett/index.html" class="no-external">The Benefits of <code>data.table</code> Syntax</a>
</h3>
<div class="listing-subtitle">
<a href="../../posts/2024-02-05-tips_tricks_1-tyson_barrett/index.html" class="no-external"></a>
</div>
<div class="listing-categories">

<div class="listing-category" onclick="window.quartoListingCategory('dGlwcw=='); return false;">tips</div>

<div class="listing-category" onclick="window.quartoListingCategory('dHV0b3JpYWxz'); return false;">tutorials</div>

<div class="listing-category" onclick="window.quartoListingCategory('ZG9jdW1lbnRhdGlvbg=='); return false;">documentation</div>

</div>
<div class="delink listing-description"><a href="../../posts/2024-02-05-tips_tricks_1-tyson_barrett/index.html" class="no-external">
Among the many reasons to use <code>data.table</code> in your code (which includes the more common answers of speed, memory efficiency, etc.) is the <strong>syntax</strong>. The syntax is
</a></div>
</div>
<div class="metadata">
<a href="../../posts/2024-02-05-tips_tricks_1-tyson_barrett/index.html" class="no-external">
<div class="listing-date">
Feb 5, 2024
</div>
<div class="listing-author">
Tyson Barrett
</div>
</a>
</div>
</div>
<div class="quarto-post image-right" data-index="17" data-categories="Z292ZXJuYW5jZSUyQ3JlbGVhc2Vz" data-listing-date-sort="1706572800000" data-listing-file-modified-sort="1752181548952" data-listing-date-modified-sort="NaN" data-listing-reading-time-sort="4" data-listing-word-count-sort="696">
<div class="thumbnail"><a href="../../posts/2024-01-30-new_governance_new_release-toby_hocking/index.html" class="no-external">

<img loading="lazy" src="../../posts/2024-01-30-new_governance_new_release-toby_hocking/New-Release.jpg" class="thumbnail-image">

</a></div>
<div class="body">
<h3 class="no-anchor listing-title">
<a href="../../posts/2024-01-30-new_governance_new_release-toby_hocking/index.html" class="no-external">New governance, release with new features</a>
</h3>
<div class="listing-subtitle">
<a href="../../posts/2024-01-30-new_governance_new_release-toby_hocking/index.html" class="no-external"></a>
</div>
<div class="listing-categories">

<div class="listing-category" onclick="window.quartoListingCategory('Z292ZXJuYW5jZQ=='); return false;">governance</div>

<div class="listing-category" onclick="window.quartoListingCategory('cmVsZWFzZXM='); return false;">releases</div>

</div>
<div class="delink listing-description"><a href="../../posts/2024-01-30-new_governance_new_release-toby_hocking/index.html" class="no-external">
I am proud to report that today, the first major new <code>data.table</code> features in several years have been released to CRAN!
</a></div>
</div>
<div class="metadata">
<a href="../../posts/2024-01-30-new_governance_new_release-toby_hocking/index.html" class="no-external">
<div class="listing-date">
Jan 30, 2024
</div>
<div class="listing-author">
Toby Dylan Hocking
</div>
</a>
</div>
</div>
<div class="quarto-post image-right" data-index="18" data-categories="dGlwcyUyQ3R1dG9yaWFscyUyQ2RvY3VtZW50YXRpb24lMkNndWVzdCUyMHBvc3Q=" data-listing-date-sort="1706400000000" data-listing-file-modified-sort="1752181548951" data-listing-date-modified-sort="NaN" data-listing-reading-time-sort="5" data-listing-word-count-sort="988">
<div class="thumbnail"><a href="../../posts/2024-01-28-piping_data_tables-elio_campitelli/index.html" class="no-external">

<img loading="lazy" src="../../posts/2024-01-28-piping_data_tables-elio_campitelli/image.jpg" class="thumbnail-image">

</a></div>
<div class="body">
<h3 class="no-anchor listing-title">
<a href="../../posts/2024-01-28-piping_data_tables-elio_campitelli/index.html" class="no-external">Piping data.tables</a>
</h3>
<div class="listing-subtitle">
<a href="../../posts/2024-01-28-piping_data_tables-elio_campitelli/index.html" class="no-external"></a>
</div>
<div class="listing-categories">

<div class="listing-category" onclick="window.quartoListingCategory('dGlwcw=='); return false;">tips</div>

<div class="listing-category" onclick="window.quartoListingCategory('dHV0b3JpYWxz'); return false;">tutorials</div>

<div class="listing-category" onclick="window.quartoListingCategory('ZG9jdW1lbnRhdGlvbg=='); return false;">documentation</div>

<div class="listing-category" onclick="window.quartoListingCategory('Z3Vlc3QlMjBwb3N0'); return false;">guest post</div>

</div>
<div class="delink listing-description"><a href="../../posts/2024-01-28-piping_data_tables-elio_campitelli/index.html" class="no-external">
Like a devoted plumber, modern R loves pipes. The magrittr pipe has a long history and it’s fair share of detractors, but with the implementation of the native pipe operator …
</a></div>
</div>
<div class="metadata">
<a href="../../posts/2024-01-28-piping_data_tables-elio_campitelli/index.html" class="no-external">
<div class="listing-date">
Jan 28, 2024
</div>
<div class="listing-author">
Elio Campitelli
</div>
</a>
</div>
</div>
<div class="quarto-post image-right" data-index="19" data-categories="YW5ub3VuY2VtZW50cyUyQ2dyYW50JTJDYW1iYXNzYWRvcnM=" data-listing-date-sort="1705190400000" data-listing-file-modified-sort="1752181548950" data-listing-date-modified-sort="NaN" data-listing-reading-time-sort="2" data-listing-word-count-sort="292">
<div class="thumbnail"><a href="../../posts/2024-01-14-ambassador_gorecki-community_team/index.html" class="no-external">

<img loading="lazy" src="../../posts/2024-01-14-ambassador_gorecki-community_team/jan.png" class="thumbnail-image">

</a></div>
<div class="body">
<h3 class="no-anchor listing-title">
<a href="../../posts/2024-01-14-ambassador_gorecki-community_team/index.html" class="no-external">Announcement: Jan Gorecki, data.table Ambassador</a>
</h3>
<div class="listing-subtitle">
<a href="../../posts/2024-01-14-ambassador_gorecki-community_team/index.html" class="no-external"></a>
</div>
<div class="listing-categories">

<div class="listing-category" onclick="window.quartoListingCategory('YW5ub3VuY2VtZW50cw=='); return false;">announcements</div>

<div class="listing-category" onclick="window.quartoListingCategory('Z3JhbnQ='); return false;">grant</div>

<div class="listing-category" onclick="window.quartoListingCategory('YW1iYXNzYWRvcnM='); return false;">ambassadors</div>

</div>
<div class="delink listing-description"><a href="../../posts/2024-01-14-ambassador_gorecki-community_team/index.html" class="no-external">
Jan is a natural choice for an Ambassador, due to his many years of fantastic contribution to the <code>data.table</code> package. You can find his great work in open-source development…<code></code>
</a></div>
</div>
<div class="metadata">
<a href="../../posts/2024-01-14-ambassador_gorecki-community_team/index.html" class="no-external">
<div class="listing-date">
Jan 14, 2024
</div>
<div class="listing-author">
Kelly Bodwin
</div>
</a>
</div>
</div>
<div class="quarto-post image-right" data-index="20" data-categories="Y29uZmVyZW5jZXM=" data-listing-date-sort="1700352000000" data-listing-file-modified-sort="1752181548950" data-listing-date-modified-sort="NaN" data-listing-reading-time-sort="3" data-listing-word-count-sort="581">
<div class="thumbnail"><a href="../../posts/2023-11-19-LatinR_summary-toby_hocking/index.html" class="no-external">

<img loading="lazy" src="../../posts/2023-11-19-LatinR_summary-toby_hocking/image.jpg" class="thumbnail-image">

</a></div>
<div class="body">
<h3 class="no-anchor listing-title">
<a href="../../posts/2023-11-19-LatinR_summary-toby_hocking/index.html" class="no-external">Summary of LatinR conference</a>
</h3>
<div class="listing-subtitle">
<a href="../../posts/2023-11-19-LatinR_summary-toby_hocking/index.html" class="no-external"></a>
</div>
<div class="listing-categories">

<div class="listing-category" onclick="window.quartoListingCategory('Y29uZmVyZW5jZXM='); return false;">conferences</div>

</div>
<div class="delink listing-description"><a href="../../posts/2023-11-19-LatinR_summary-toby_hocking/index.html" class="no-external">
Last month, I (Toby) went to the LatinR conference in Montevideo, Uruguay. I had two goals: to teach about <code>data.table</code> in a tutorial, and to find people to work on…
</a></div>
</div>
<div class="metadata">
<a href="../../posts/2023-11-19-LatinR_summary-toby_hocking/index.html" class="no-external">
<div class="listing-date">
Nov 19, 2023
</div>
<div class="listing-author">
Toby Dylan Hocking
</div>
</a>
</div>
</div>
<div class="quarto-post image-right" data-index="21" data-categories="YW5ub3VuY2VtZW50cyUyQ2dyYW50JTJDZnVuZGluZyUyMG9wcG9ydHVuaXR5" data-listing-date-sort="1698796800000" data-listing-file-modified-sort="1752181548948" data-listing-date-modified-sort="NaN" data-listing-reading-time-sort="3" data-listing-word-count-sort="428">
<div class="thumbnail"><a href="../../posts/2023-11-01-travel_grant_announcement-community_team/index.html" class="no-external">

<img loading="lazy" src="../../posts/2023-11-01-travel_grant_announcement-community_team/image.jpg" class="thumbnail-image">

</a></div>
<div class="body">
<h3 class="no-anchor listing-title">
<a href="../../posts/2023-11-01-travel_grant_announcement-community_team/index.html" class="no-external">Announcement: The data.table Ambassadors Travel Grant</a>
</h3>
<div class="listing-subtitle">
<a href="../../posts/2023-11-01-travel_grant_announcement-community_team/index.html" class="no-external"></a>
</div>
<div class="listing-categories">

<div class="listing-category" onclick="window.quartoListingCategory('YW5ub3VuY2VtZW50cw=='); return false;">announcements</div>

<div class="listing-category" onclick="window.quartoListingCategory('Z3JhbnQ='); return false;">grant</div>

<div class="listing-category" onclick="window.quartoListingCategory('ZnVuZGluZyUyMG9wcG9ydHVuaXR5'); return false;">funding opportunity</div>

</div>
<div class="delink listing-description"><a href="../../posts/2023-11-01-travel_grant_announcement-community_team/index.html" class="no-external">
We on the community team are very excited to announce another major funding opportunity!
</a></div>
</div>
<div class="metadata">
<a href="../../posts/2023-11-01-travel_grant_announcement-community_team/index.html" class="no-external">
<div class="listing-date">
Nov 1, 2023
</div>
<div class="listing-author">
Kelly Bodwin
</div>
</a>
</div>
</div>
<div class="quarto-post image-right" data-index="22" data-categories="YW5ub3VuY2VtZW50cyUyQ2dyYW50JTJDZnVuZGluZyUyMG9wcG9ydHVuaXR5" data-listing-date-sort="1697500800000" data-listing-file-modified-sort="1752181548947" data-listing-date-modified-sort="NaN" data-listing-reading-time-sort="4" data-listing-word-count-sort="664">
<div class="thumbnail"><a href="../../posts/2023-10-17-translation_announcement-toby_hocking/index.html" class="no-external">

<img loading="lazy" src="../../posts/2023-10-17-translation_announcement-toby_hocking/translate.jpeg" class="thumbnail-image">

</a></div>
<div class="body">
<h3 class="no-anchor listing-title">
<a href="../../posts/2023-10-17-translation_announcement-toby_hocking/index.html" class="no-external">Announcement: data.table translation projects</a>
</h3>
<div class="listing-subtitle">
<a href="../../posts/2023-10-17-translation_announcement-toby_hocking/index.html" class="no-external"></a>
</div>
<div class="listing-categories">

<div class="listing-category" onclick="window.quartoListingCategory('YW5ub3VuY2VtZW50cw=='); return false;">announcements</div>

<div class="listing-category" onclick="window.quartoListingCategory('Z3JhbnQ='); return false;">grant</div>

<div class="listing-category" onclick="window.quartoListingCategory('ZnVuZGluZyUyMG9wcG9ydHVuaXR5'); return false;">funding opportunity</div>

</div>
<div class="delink listing-description"><a href="../../posts/2023-10-17-translation_announcement-toby_hocking/index.html" class="no-external">
In 2023-2025, National Science Foundation (NSF) has provided funds to support the project “Expanding the data.table ecosystem for efficient big data manipulation in R.” One…<code></code>
</a></div>
</div>
<div class="metadata">
<a href="../../posts/2023-10-17-translation_announcement-toby_hocking/index.html" class="no-external">
<div class="listing-date">
Oct 17, 2023
</div>
</a>
</div>
</div>
<div class="quarto-post image-right" data-index="23" data-categories="YW5ub3VuY2VtZW50cyUyQ2dyYW50" data-listing-date-sort="1697328000000" data-listing-file-modified-sort="1752181548946" data-listing-date-modified-sort="NaN" data-listing-reading-time-sort="4" data-listing-word-count-sort="640">
<div class="thumbnail"><a href="../../posts/2023-10-15-intro_to_grant-toby_hocking/index.html" class="no-external">

<img loading="lazy" src="../../posts/2023-10-15-intro_to_grant-toby_hocking/sea_lions.jpg" class="thumbnail-image">

</a></div>
<div class="body">
<h3 class="no-anchor listing-title">
<a href="../../posts/2023-10-15-intro_to_grant-toby_hocking/index.html" class="no-external">Welcome to the data.table ecosystem project!</a>
</h3>
<div class="listing-subtitle">
<a href="../../posts/2023-10-15-intro_to_grant-toby_hocking/index.html" class="no-external">An NSF-POSE funded venture.</a>
</div>
<div class="listing-categories">

<div class="listing-category" onclick="window.quartoListingCategory('YW5ub3VuY2VtZW50cw=='); return false;">announcements</div>

<div class="listing-category" onclick="window.quartoListingCategory('Z3JhbnQ='); return false;">grant</div>

</div>
<div class="delink listing-description"><a href="../../posts/2023-10-15-intro_to_grant-toby_hocking/index.html" class="no-external">
Hi! My name is Toby Dylan Hocking, and I have been using R since 2003, which means 20 years, can you believe it?
</a></div>
</div>
<div class="metadata">
<a href="../../posts/2023-10-15-intro_to_grant-toby_hocking/index.html" class="no-external">
<div class="listing-date">
Oct 15, 2023
</div>
<div class="listing-author">
Toby Hocking
</div>
</a>
</div>
</div>
</div>
<div class="listing-no-matching d-none">No matching items</div>
</div><div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-Becker1985" class="csl-entry" role="listitem">
Becker, Richard A., and John M. Chambers. 1985. <em>Extending the <span>S</span> System</em>. The <span>Wadsworth</span> Statistics/Probability Series. Monterey, Calif: Wadsworth.
</div>
<div id="ref-Chambers2016" class="csl-entry" role="listitem">
Chambers, John M. 2016. <em>Extending <span>R</span></em>. Chapman &amp; <span>Hall</span> / <span>CRC</span> <span>The</span> <span>R</span> <span>Series</span>. Milton: CRC Press.
</div>
<div id="ref-Cormen2009" class="csl-entry" role="listitem">
Cormen, Thomas H., Charles Eric Leiserson, Ronald Linn Rivest, and Clifford Stein. 2009. <em>Introduction to Algorithms</em>. Third edition. Cambridge, Massachusetts London, England: MIT Press.
</div>
<div id="ref-Jones2012" class="csl-entry" role="listitem">
Jones, Richard, Antony Hosking, and Eliot Moss. 2012. <em>The Garbage Collection Handbook: The Art of Automatic Memory Management</em>. Applied Algorithms and Data Structures Series. Boca Raton, FL: CRC Press.
</div>
<div id="ref-Nash2024" class="csl-entry" role="listitem">
Nash, John C., and Arkajyoti Bhattacharjee. 2024. <span>“A Comparison of <span>R</span> Tools for Nonlinear Least Squares Modeling.”</span> <em>The R Journal</em> 15: 198–215. <a href="https://doi.org/10.32614/RJ-2023-091">https://doi.org/10.32614/RJ-2023-091</a>.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/rdatatable-community\.github\.io\/The-Raft");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>